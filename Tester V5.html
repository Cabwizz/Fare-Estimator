<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CabWizz — Dual Tester v5 (Old vs New Scalable)</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --bd:#e5e5ea;
    --over:#1869ff; /* estimator > meter */
    --under:#d23636; /* estimator < meter */
    --near:#111;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:12px;color:#111}
  h1{font-size:18px;margin:0 0 10px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px;margin:10px 0}
  .grid{display:grid;gap:10px}
  .controls{grid-template-columns:repeat(5,minmax(0,1fr))}
  .inputs{grid-template-columns:1fr 1fr}
  @media (max-width:980px){.controls{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (max-width:560px){.controls{grid-template-columns:repeat(2,minmax(0,1fr))}.inputs{grid-template-columns:1fr}}
  label{font-size:12px;color:#444;display:block;margin-bottom:4px}
  input,select,button,textarea{width:100%;font-size:14px;border-radius:12px;border:1px solid var(--bd);padding:10px;background:#fff}
  textarea{min-height:130px}
  button{font-weight:600;cursor:pointer}
  .btn{background:#0a7;color:#fff;border:none}
  .btn.alt{background:#1869ff}
  .btn.gray{background:#fff;color:#111;border:1px solid var(--bd)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .over{color:var(--over);font-weight:700}
  .under{color:var(--under);font-weight:700}
  .near{color:var(--near)}
  .tiny{color:#666;font-size:12px;margin-top:6px}
</style>
</head>
<body>
  <h1>CabWizz — Dual Tester v5 (Old vs New Scalable)</h1>

  <!-- Minimal controls -->
  <div class="card">
    <div class="grid controls">
      <div>
        <label>Rate</label>
        <select id="rateSel">
          <option value="rate1">Rate 1</option>
          <option value="rate2">Rate 2</option>
          <option value="rate3">Rate 3</option>
        </select>
      </div>
      <div>
        <label>Tolerance (±£)</label>
        <input id="tol" type="number" step="0.1" value="0.60">
      </div>
      <div>
        <label>Sort by |Δ|</label>
        <select id="sortSel">
          <option value="none" selected>None</option>
          <option value="old_asc">Old least → most</option>
          <option value="old_desc">Old most → least</option>
          <option value="new_asc">New least → most</option>
          <option value="new_desc">New most → least</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="recalcBtn">Recalculate</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn alt" id="exportBtn">Export CSV</button>
      </div>
    </div>
  </div>

  <!-- Paste data -->
  <div class="card">
    <div class="grid inputs">
      <div>
        <label>Paste CSV (minutes,miles,meter) — one per line</label>
        <textarea id="pasteBox" placeholder="e.g. 29,6.3,35.80&#10;43,6.0,44.40&#10;38,6.0,41.20&#10;30,6.0,35.40"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="addPasted">Add pasted rows</button>
          <button class="btn gray" id="clearAll">Clear table</button>
        </div>
        <div class="tiny">Over = blue (estimator &gt; meter). Under = red (estimator &lt; meter). |Δ| ≤ tolerance = black.</div>
      </div>
      <div>
        <label>Quick add (one row)</label>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
          <div><input id="qMin"   type="number" step="1"   placeholder="Minutes"></div>
          <div><input id="qMi"    type="number" step="0.1" placeholder="Miles"></div>
          <div><input id="qMeter" type="number" step="0.01" placeholder="Meter £"></div>
        </div>
        <button class="btn" id="addOne" style="margin-top:8px">Add row</button>
        <p class="mono" style="margin-top:10px;color:#555">Paste ONLY: minutes,miles,meter</p>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="card" style="max-height:65vh;overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Min</th>
          <th>Mi</th>
          <th>Meter</th>
          <th>Old core</th>
          <th>Δ Old</th>
          <th>New core</th>
          <th>Δ New</th>
          <th>Δ(New−Old)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
/* ========= Helpers ========= */
const $ = id => document.getElementById(id);
const r2 = x => Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const floorTo = (x,inc)=>Math.floor(x/inc)*inc;
const ceilTo  = (x,inc)=>Math.ceil (x/inc)*inc;

/* ========= Shared pieces ========= */
const INC = 0.20;
const BASE_FARE = 4.20;

// Per-minute tiers and per-mile rules as used historically (same across models)
const MODEL = {
  rate1:{
    perMinute:[ {upTo:6,v:0.29},{upTo:12,v:0.34},{upTo:25,v:0.38},{v:0.46} ],
    perMile:[ {when:{mMax:2.0},v:3.60},{when:{mMin:2.0,mMax:3.5},v:3.75},{when:{mMin:3.5,mMax:4.8},v:3.90},{when:{mMin:4.8,mMax:7.0},v:4.00},{when:{mMin:7.0,mMax:15},v:4.08},{when:{mMin:15,mMax:25},v:3.95},{v:3.80} ]
  },
  rate2:{
    perMinute:[ {upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60} ],
    perMile:[ {when:{mMax:1.0},v:3.60},{when:{mMin:1.0,mMax:2.2},v:3.75},{when:{mMin:2.2,mMax:3.5},v:3.95},{when:{mMin:3.5,mMax:4.6},v:4.15},{when:{mMin:4.6,mMax:7.5},v:4.35},{when:{mMin:7.5,mMax:10},v:4.05},{when:{mMin:10},v:4.10} ]
  },
  rate3:{
    perMinute:[ {upTo:10,v:0.60},{upTo:20,v:0.64},{upTo:35,v:0.55},{v:0.45} ],
    perMile:[ {when:{mMax:3.0},v:3.95},{when:{mMin:3.0,mMax:5.0},v:3.65},{when:{mMin:5.0,mMax:6.5},v:3.40},{when:{mMin:6.6,mMax:9.0},v:3.20},{v:3.10} ]
  }
};

// Range rules (visual tolerance bands)
const RANGE = {
  inc: INC,
  bands: [
    { max: 1.5, lower:{fixed:0.30,pct:0.02}, upper:{fixed:0.60,pct:0.05} },
    { max: 2.5, lower:{fixed:0.60,pct:0.04}, upper:{fixed:1.00,pct:0.06} },
    { max: 4.5, lower:{fixed:1.00,pct:0.04}, upper:{fixed:1.60,pct:0.06} },
    { max: 6.5, lower:{fixed:1.60,pct:0.04}, upper:{fixed:2.00,pct:0.05} },
    { max: 1e9, lower:{fixed:2.00,pct:0.02}, upper:{fixed:2.50,pct:0.04} },
  ]
};
function baseBand(mi){ return RANGE.bands.find(x=>mi<=x.max) || RANGE.bands[RANGE.bands.length-1]; }
function clampByFareSize(core, lower, upper){
  if(core<=20){ lower=Math.min(lower, core-1.00); upper=Math.max(upper, core+1.00); }
  else if(core<=40){ lower=Math.min(lower, core-1.20); upper=Math.max(upper, core+1.20); }
  else if(core<=60){ lower=Math.min(lower, core-1.40); upper=Math.max(upper, core+1.40); }
  else { lower=Math.min(lower, core-1.60); upper=Math.max(upper, core+1.60); }
  return {lower,upper};
}
function buildRange(core, mi, mn){
  const inc = RANGE.inc;
  const b = baseBand(mi);
  let lowerAdj = Math.max(b.lower.fixed, core*b.lower.pct);
  let upperAdj = Math.max(b.upper.fixed, core*b.upper.pct);

  if(mi<=1.0){ lowerAdj = Math.min(lowerAdj,1.00); upperAdj = Math.min(Math.max(upperAdj,1.20),1.80); }
  if(mi<=2.5 && mn>=15){ lowerAdj = Math.max(lowerAdj*1.05, lowerAdj+0.30); upperAdj = Math.max(upperAdj*1.20, upperAdj+0.80); }
  if(mi>=6 && mn>=35){ upperAdj = Math.max(upperAdj*1.12, upperAdj+0.80); }

  let lower = floorTo(roundTo(core - lowerAdj, inc), inc);
  let upper = ceilTo (roundTo(core + upperAdj, inc), inc);
  const cl = clampByFareSize(core, lower, upper);
  lower = cl.lower; upper = cl.upper;

  if(mi<=0.8 && lower<6.20) lower = roundTo(6.20, inc);
  return {lower, upper};
}

/* ========= Core calculators ========= */
function matchesWhen(w, miles){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  return true;
}
function pickPerMile(rules, miles){
  const r = rules.find(x=>matchesWhen(x.when, miles));
  return (r||rules[rules.length-1]).v;
}
function minutePart(tiers, mins){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    const up = t.upTo==null ? Infinity : t.upTo;
    const span = Math.max(0, Math.min(rem, up-used));
    sum += span * t.v;
    rem -= span; used += span; if(rem<=0) break;
  }
  return sum;
}

/* ========= Scalable models =========
   OLD:  base + minute + per-mile (+ R3 extra uplift); T4 align at ≥6.0mi
   NEW:  same as OLD, plus:
         • R1 +£1.20 for 1.5–2.2 mi & ≥13 min
         • R1 −5% softening for 6–7 mi (applied to total core before rounding)
*/
const T4_THRESHOLD = 6.0; // Tariff-4 alignment ON
function r3Extra(mins, miles){
  if(miles>=3 && miles<=7 && mins>30){
    const k = 0.20 + 0.015*miles;
    return roundTo(k*(mins-30), INC);
  }
  return 0;
}

function estimateScalableOLD(rateKey, mins, miles){
  const rate = MODEL[rateKey];
  // minute
  const mPart = minutePart(rate.perMinute, mins);

  // per-mile with T4 alignment (use Rate 2 per-mile at ≥ threshold)
  const perMileRules = (miles >= T4_THRESHOLD) ? MODEL.rate2.perMile : rate.perMile;
  const perMi = pickPerMile(perMileRules, miles);
  const milePart = perMi * miles;

  // R3 extra uplift kept
  const extra = (rateKey==='rate3') ? r3Extra(mins, miles) : 0;

  let core = BASE_FARE + mPart + milePart + extra;
  core = roundTo(core, INC);

  const rng = buildRange(core, miles, mins);
  return {core, lower:rng.lower, upper:rng.upper};
}

function estimateScalableNEW(rateKey, mins, miles){
  // Start from OLD behaviour
  let {core} = estimateScalableOLD(rateKey, mins, miles);

  // v5 tweaks (Rate 1 only)
  if(rateKey==='rate1'){
    // +£1.20 correction for 1.5–2.2 mi & ≥13 min
    if(miles>=1.5 && miles<=2.2 && mins>=13){
      core += 1.20;
    }
    // −5% softening for 6–7 miles (apply before rounding to band)
    if(miles>=6.0 && miles<=7.0){
      core = core * 0.95;
    }
  }

  core = roundTo(core, INC);
  const rng = buildRange(core, miles, mins);
  return {core, lower:rng.lower, upper:rng.upper};
}

/* ========= UI logic ========= */
let rows = []; // {mins, miles, meter}

function parseCSV(text){
  const out=[];
  text.split(/\r?\n/).forEach(line=>{
    const s=line.trim(); if(!s) return;
    const parts=s.split(',').map(x=>x.trim());
    if(parts.length<3) return;
    const mins  = Number(parts[0]);
    const miles = Number(parts[1]);
    const meter = Number(String(parts[2]).replace('£',''));
    if(Number.isFinite(mins)&&Number.isFinite(miles)&&Number.isFinite(meter)){
      out.push({mins,miles,meter});
    }
  });
  return out;
}

function cls(err, tol){ return Math.abs(err)<=tol ? 'near' : (err>0 ? 'over' : 'under'); }

function recalcAndRender(){
  const rate = $('rateSel').value;
  const tol  = Number($('tol').value)||0.60;
  const sort = $('sortSel').value;

  const computed = rows.map((r,i)=>{
    const o = estimateScalableOLD(rate, r.mins, r.miles);
    const n = estimateScalableNEW(rate, r.mins, r.miles);
    const errO = r2(o.core - r.meter);
    const errN = r2(n.core - r.meter);
    const dNewOld = r2(n.core - o.core);
    return {idx:i+1, ...r, o, n, errO, errN, dNewOld};
  });

  let view = computed;
  if(sort==='old_asc')  view = [...view].sort((a,b)=>Math.abs(a.errO)-Math.abs(b.errO));
  if(sort==='old_desc') view = [...view].sort((a,b)=>Math.abs(b.errO)-Math.abs(a.errO));
  if(sort==='new_asc')  view = [...view].sort((a,b)=>Math.abs(a.errN)-Math.abs(b.errN));
  if(sort==='new_desc') view = [...view].sort((a,b)=>Math.abs(b.errN)-Math.abs(a.errN));

  const tb = $('tbody'); tb.innerHTML='';
  for(const r of view){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${r.idx}</td>
      <td>${r.mins}</td>
      <td>${r.miles.toFixed(1)}</td>
      <td class="mono">£${r.meter.toFixed(2)}</td>

      <td class="mono">£${r.o.core.toFixed(2)}</td>
      <td class="mono ${cls(r.errO,tol)}">${r.errO>0?'+':''}${r.errO.toFixed(2)}</td>

      <td class="mono">£${r.n.core.toFixed(2)}</td>
      <td class="mono ${cls(r.errN,tol)}">${r.errN>0?'+':''}${r.errN.toFixed(2)}</td>

      <td class="mono">${r.dNewOld>0?'+':''}${r.dNewOld.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  }
}

$('addPasted').addEventListener('click', ()=>{
  const arr = parseCSV($('pasteBox').value);
  if(arr.length){ rows = rows.concat(arr); $('pasteBox').value=''; recalcAndRender(); }
});
$('addOne').addEventListener('click', ()=>{
  const mins  = Number($('qMin').value);
  const miles = Number($('qMi').value);
  const meter = Number($('qMeter').value);
  if(Number.isFinite(mins)&&Number.isFinite(miles)&&Number.isFinite(meter)){
    rows.push({mins,miles,meter});
    $('qMin').value=$('qMi').value=$('qMeter').value='';
    recalcAndRender();
  }
});
['rateSel','tol','sortSel'].forEach(id=>$(id).addEventListener('input', recalcAndRender));
$('recalcBtn').addEventListener('click', recalcAndRender);
$('clearAll').addEventListener('click', ()=>{ rows=[]; recalcAndRender(); });

$('exportBtn').addEventListener('click', ()=>{
  const tol = Number($('tol').value)||0.60;
  const rate = $('rateSel').value;
  const th = ["minutes","miles","meter",
              "core_old","diff_old",
              "core_new","diff_new",
              "delta_new_minus_old",
              "rate","t4_align_miles","tolerance"];
  const out = rows.map(r=>{
    const o = estimateScalableOLD(rate, r.mins, r.miles);
    const n = estimateScalableNEW(rate, r.mins, r.miles);
    const errO = r2(o.core - r.meter), errN = r2(n.core - r.meter);
    return [r.mins,r.miles,r.meter,
            o.core,errO,
            n.core,errN,
            r2(n.core - o.core),
            rate,T4_THRESHOLD,tol];
  });
  const csv = [th.join(',')].concat(out.map(a=>a.join(','))).join('\r\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='cabwizz_dual_tester_v5.csv'; a.click(); URL.revokeObjectURL(a.href);
});

// init
recalcAndRender();
</script>
</body>
</html>
