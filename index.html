<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a7">
<title>CabWizz Fare Estimator</title>
<style>
  :root{--ok:#0a7;--warn:#f8a100;--info:#1869ff;--danger:#d33}

  /* Global */
  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:12px; line-height:1.25; background:#f7f7f8; color:#111;
  }
  h1{font-size:18px;margin:0 0 8px}

  /* Cards */
  .card{
    border:1px solid #e5e5ea;
    border-radius:16px;
    padding:14px;
    margin:10px 0;
    background:#fff;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
  }

  /* Form bits */
  label{display:block;font-size:14px;margin:10px 0 6px;color:#333}
  input,select,button{
    font-size:16px;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid #d1d1d6;
    width:100%;
    background:#fff;
  }
  input::placeholder{color:#b0b0b5}
  .row{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
  @media (max-width:420px){ .row{grid-template-columns:1fr} }
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media (max-width:420px){ .row3{grid-template-columns:1fr} }

  /* Output */
  .out{font-weight:700}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{color:#666}

  /* Buttons: stacked, pill, colored */
  .btns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .btn{
    border:none; color:#fff; font-weight:600; text-align:center;
    border-radius:16px; padding:14px; width:100%;
    box-shadow:0 1px 0 rgba(0,0,0,.08), inset 0 -1px 0 rgba(0,0,0,.08);
  }
  .ok{background:var(--ok)}
  .warn{background:var(--warn)}
  .info{background:var(--info)}
  .danger{background:var(--danger)}

  /* Table */
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  /* Footer note under the buttons like your screenshot */
  .tiny{color:#888;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<h1>CabWizz Fare Estimator</h1>

<div class="card">
  <div class="row">
    <div>
      <label for="mins">Minutes</label>
      <input id="mins" type="number" inputmode="numeric" step="1" min="0" placeholder="e.g. 20" />
    </div>
    <div>
      <label for="miles">Miles</label>
      <input id="miles" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 5.0" />
    </div>
  </div>

  <div style="margin-top:10px">
    <label for="meter">Actual meter fare (optional)</label>
    <input id="meter" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 17.40" />
  </div>

  <div class="row3" style="margin-top:12px">
    <div>
      <div class="muted">Rate 1</div>
      <div class="out mono" id="r1">–</div>
    </div>
    <div>
      <div class="muted">Rate 2</div>
      <div class="out mono" id="r2">–</div>
    </div>
    <div>
      <div class="muted">Rate 3</div>
      <div class="out mono" id="r3">–</div>
    </div>
  </div>

  <!-- Stacked buttons in the exact order/colors from your screenshot -->
  <div class="btns">
    <button class="btn ok" id="calcBtn">Calculate</button>
    <button class="btn warn" id="saveBtn">Save Journey</button>
    <button class="btn info" id="exportBtn">Export CSV</button>
    <button class="btn danger" id="clearBtn">Clear Log</button>
  </div>
  <div class="tiny">One-file version (no caching). Add to Home Screen if you like.</div>
</div>

<div class="card">
  <div class="muted">Saved Journeys</div>
  <div style="max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:12px; margin-top:6px">
    <table id="logTbl">
      <thead>
        <tr>
          <th>#</th>
          <th>When</th>
          <th>Min</th>
          <th>Mi</th>
          <th>Rate 1 (core / range)</th>
          <th>Rate 2 (core / range)</th>
          <th>Rate 3 (core / range)</th>
          <th>Meter</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
/* (kept same logic you approved, including long-journey softening) */
const cfg = {
  baseFare: 4.20,
  inc: 0.20,
  rangeBands: [
    { max: 1.5, lower:{fixed:0.40,pct:0.03}, upper:{fixed:0.80,pct:0.07} },
    { max: 2.5, lower:{fixed:0.80,pct:0.05}, upper:{fixed:1.40,pct:0.09} },
    { max: 4.5, lower:{fixed:1.60,pct:0.06}, upper:{fixed:2.40,pct:0.09} },
    { max: 6.5, lower:{fixed:2.20,pct:0.06}, upper:{fixed:2.80,pct:0.07} },
    { max: 1e9, lower:{fixed:2.50,pct:0.03}, upper:{fixed:3.50,pct:0.06} },
  ],
 rate1:{
  perMinute:[{upTo:12,v:0.30},{upTo:25,v:0.34},{v:0.40}],
  perMileRules:[
    /* keep your short-window special */
    {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:3.35},

    /* NEW mileage-shaped bands for R1 */
    {when:{mMin:25}, v:3.65},
    {when:{mMin:15}, v:3.80},
    {when:{mMin:7},  v:4.00},

    /* existing ≤6 mi rule */
    {when:{mMax:6.0}, v:3.60},

    /* fallback (rarely used now; covers 6–7 mi if needed) */
    {v:4.29}
  ],
  offsets:[],
  /* keep very-long softener */
  longTrim:{ enabled:true, when:{mMin:20,tMin:55}, pct:0.06, minAbs:4.00 }
},

  },
  rate2:{
    perMinute:[{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60}],
    perMileRules:[
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, v:3.80},
      {when:{mMin:20.0001}, v:4.15},
      {when:{mMin:7.5}, v:4.15},
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:4.05},
      {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, v:3.70},
      {v:4.29}
    ],
    offsets:[
      {when:{mMax:1.2,tMin:6,tMax:13}, d:1.00},
      {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, d:0.40},
      {when:{mMin:18,mMax:21,tMin:45,tMax:60}, d:-2.00},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, d:-2.00}
    ],
    longTrim:{ enabled:true, when:{mMin:20,tMin:55}, pct:0.06, minAbs:4.00 }
  },
  rate3:{
    perMinute:[{upTo:12,v:0.58},{upTo:30,v:0.62},{v:0.44}],
    perMileRules:[{v:4.00}],
    offsets:[
      {when:{mMax:0.5,tMax:5}, d:-1.20},
      {when:{mMax:0.8,tMax:5}, d:-0.60},
      {when:{mMin:1.8,mMax:2.2,tMin:9,tMax:12}, d:-1.40},
      {when:{mMin:5.5,mMax:6.3,tMin:28,tMax:40}, d:-1.60},
      {when:{mMin:18,mMax:20,tMin:45,tMax:60}, d:1.50},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, d:-1.80}
    ]
  }
};

/* ========= Helpers ========= */
const r2 = (x)=>Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const floorTo  = (x,inc)=>Math.floor(x/inc)*inc;
const ceilTo   = (x,inc)=>Math.ceil (x/inc)*inc;

function matches(w, miles, mins){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  if(w.tMin!==undefined && mins  < w.tMin) return false;
  if(w.tMax!==undefined && mins  > w.tMax) return false;
  return true;
}
function pickPerMile(rules, miles, mins){
  const r = rules.find(x=>matches(x.when,miles,mins));
  return (r||rules[rules.length-1]).v;
}
function minutePart(tiers, mins){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    if(t.upTo==null){ sum+=rem*t.v; break; }
    const span=Math.max(0, Math.min(rem, t.upTo-used));
    sum += span*t.v; rem-=span; used+=span;
    if(rem<=0) break;
  }
  return sum;
}
function sumOffsets(arr, miles, mins){
  return arr.reduce((s,o)=>s+(matches(o.when,miles,mins)?o.d:0),0);
}
function longTrim(core, trim, miles, mins){
  if(!trim||!trim.enabled) return core;
  if(!matches(trim.when,miles,mins)) return core;
  const rounded = roundTo(core, cfg.inc);
  const dec = Math.max(trim.minAbs, roundTo(rounded*trim.pct, cfg.inc));
  return roundTo(rounded - dec, cfg.inc);
}
function rangeAround(core, miles){
  const b = cfg.rangeBands.find(x=>miles<=x.max) || cfg.rangeBands[cfg.rangeBands.length-1];
  const lowerAdj = Math.max(b.lower.fixed, core*b.lower.pct);
  const upperAdj = Math.max(b.upper.fixed, core*b.upper.pct);
  const lower = floorTo(roundTo(core - lowerAdj, cfg.inc), cfg.inc);
  const upper = ceilTo (roundTo(core + upperAdj, cfg.inc), cfg.inc);
  return {lower, upper};
}

/* ========= Core calculators ========= */
function estimate(rateKey, mins, miles){
  const r = cfg[rateKey];
  const mPart = minutePart(r.perMinute, mins);
  const perMile = pickPerMile(r.perMileRules, miles, mins);
  let core = cfg.baseFare + mPart + perMile*miles + sumOffsets(r.offsets||[], miles, mins);
  if(r.longTrim) core = longTrim(core, r.longTrim, miles, mins);
  core = roundTo(core, cfg.inc);
  const rng = rangeAround(core, miles);
  return { core, lower:rng.lower, upper:rng.upper };
}

/* ========= UI wiring ========= */
const $ = (id)=>document.getElementById(id);
function fmt(x){ return '£'+r2(x).toFixed(2); }
function fmtRange(core,lo,hi){ return `${fmt(core)}  (${fmt(lo)}–${fmt(hi)})`; }

function refresh(){
  const mins = Number($('mins').value);
  const miles= Number($('miles').value);
  if(Number.isNaN(mins)||Number.isNaN(miles)) return;

  const r1 = estimate('rate1', mins, miles);
  const r2 = estimate('rate2', mins, miles);
  const r3 = estimate('rate3', mins, miles);

  $('r1').textContent = fmtRange(r1.core, r1.lower, r1.upper);
  $('r2').textContent = fmtRange(r2.core, r2.lower, r2.upper);
  $('r3').textContent = fmtRange(r3.core, r3.lower, r3.upper);

  return {mins, miles, r1, r2, r3};
}

/* ========= Logging (localStorage) ========= */
const KEY='cabwizz_log_v1';
function loadLog(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return [] } }
function saveLog(rows){ localStorage.setItem(KEY, JSON.stringify(rows)); renderLog(); }
function renderLog(){
  const body = $('logBody'); body.innerHTML='';
  const rows = loadLog();
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="mono">${r.when}</td>
      <td>${r.mins}</td>
      <td>${r.miles}</td>
      <td class="mono">${r.r1}</td>
      <td class="mono">${r.r2}</td>
      <td class="mono">${r.r3}</td>
      <td>${r.meter? '£'+Number(r.meter).toFixed(2):''}</td>
    `;
    body.appendChild(tr);
  });
}

function weekdayStamp(d=new Date()){
  const wk=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
  const pad=n=>String(n).padStart(2,'0');
  return `${wk} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ========= Export CSV ========= */
function exportCSV(){
  const rows = loadLog();
  const head = ['#','When','Minutes','Miles','Rate1 (core/range)','Rate2 (core/range)','Rate3 (core/range)','Meter'];
  const csv = [head].concat(rows.map((r,i)=>[
    i+1, r.when, r.mins, r.miles, r.r1, r.r2, r.r3, r.meter||''
  ])).map(arr=>arr.map(v=>{
    const s=String(v).replaceAll('"','""');
    return `"${s}"`;
  }).join(',')).join('\r\n');

  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='cabwizz_journeys.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= Optional webhook to Google Sheets ========= */
const WEBHOOK_URL = '';
async function sendWebhook(payload){
  if(!WEBHOOK_URL) return;
  try{
    await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  }catch(e){ console.warn('Webhook failed',e); }
}

/* ========= Events ========= */
document.getElementById('calcBtn').addEventListener('click', refresh);
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const res = refresh(); if(!res) return;
  const meter = document.getElementById('meter').value;
  const row = {
    when: weekdayStamp(),
    mins: res.mins, miles: res.miles,
    r1: fmtRange(res.r1.core,res.r1.lower,res.r1.upper),
    r2: fmtRange(res.r2.core,res.r2.lower,res.r2.upper),
    r3: fmtRange(res.r3.core,res.r3.lower,res.r3.upper),
    meter: meter? Number(meter).toFixed(2):''
  };
  const rows = loadLog(); rows.push(row); saveLog(rows);
  await sendWebhook(row);
  document.getElementById('meter').value='';
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Clear ALL saved journeys?')){ saveLog([]); }
});
document.getElementById('exportBtn').addEventListener('click', exportCSV);
['mins','miles'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{ if(document.getElementById(id).value!=='') refresh(); });
});
renderLog();

// Register service worker when hosted (https/http), not for file://
if (location.protocol.startsWith('http') && 'serviceWorker' in navigator) {
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('sw.js').catch(console.warn);
  });
}
</script>
</body>
</html>
