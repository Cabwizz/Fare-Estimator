<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CabWizz — Dual Tester v5 (Old Scalable vs New Tweaked)</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --bd:#e5e5ea;
    --blue:#1869ff; /* OVER */
    --red:#d23636;  /* UNDER */
    --near:#111;    /* within tolerance */
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:12px;color:#111}
  h1{font-size:18px;margin:0 0 10px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px;margin:10px 0}
  .grid{display:grid;gap:10px}
  .controls{grid-template-columns:repeat(6,minmax(0,1fr))}
  .inputs{grid-template-columns:1fr 1fr}
  @media (max-width:980px){.controls{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (max-width:560px){.controls{grid-template-columns:repeat(2,minmax(0,1fr))}.inputs{grid-template-columns:1fr}}
  label{font-size:12px;color:#444;display:block;margin-bottom:4px}
  input,select,button,textarea{width:100%;font-size:14px;border-radius:12px;border:1px solid var(--bd);padding:10px;background:#fff}
  textarea{min-height:120px}
  button{font-weight:600;cursor:pointer}
  .btn{background:#0a7;color:#fff;border:none}
  .btn.alt{background:#1869ff}
  .btn.gray{background:#fff;color:#111;border:1px solid var(--bd)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .over{color:var(--blue);font-weight:700}
  .under{color:var(--red);font-weight:700}
  .near{color:var(--near)}
  details summary{cursor:pointer;font-weight:600}
  .tiny{color:#666;font-size:12px;margin-top:6px}
</style>
</head>
<body>
  <h1>CabWizz — Dual Tester v5 (Old Scalable vs New Tweaked)</h1>

  <!-- Top controls -->
  <div class="card">
    <div class="grid controls">
      <div>
        <label>Rate (calculate rows as)</label>
        <select id="rateSel">
          <option value="rate1">Rate 1</option>
          <option value="rate2">Rate 2</option>
          <option value="rate3">Rate 3</option>
        </select>
      </div>

      <div>
        <label>Base Fare (£)</label>
        <input id="baseFare" type="number" step="0.01" value="4.20">
      </div>

      <div>
        <label>Global uplift (%)</label>
        <input id="upliftGlobal" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Rate-1 uplift (%)</label>
        <input id="upliftR1" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Rate-2 uplift (%)</label>
        <input id="upliftR2" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Rate-3 uplift (%)</label>
        <input id="upliftR3" type="number" step="0.01" value="0">
      </div>

      <div>
        <label>Rate-4 align (≥ miles)</label>
        <input id="t4Miles" type="number" step="0.1" value="6.0">
      </div>
      <div>
        <label>Rate-4 alignment</label>
        <select id="t4Align">
          <option value="on" selected>On (use Rate-2 per-mile ≥ threshold)</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div>
        <label>Rate-4 uplift (%) — per-mile only</label>
        <input id="upliftR4" type="number" step="0.01" value="0">
      </div>

      <div>
        <label>Tolerance (±£)</label>
        <input id="tol" type="number" step="0.1" value="0.60">
      </div>
      <div>
        <label>Sort by |Δ|</label>
        <select id="sortSel">
          <option value="none" selected>None</option>
          <option value="old_asc">Old least → most</option>
          <option value="old_desc">Old most → least</option>
          <option value="new_asc">New least → most</option>
          <option value="new_desc">New most → least</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="recalcBtn">Recalculate</button>
      </div>
    </div>
  </div>

  <!-- Band Tweaks (simple £ adds per 1-mile band, up to 10mi) -->
  <div class="card">
    <details>
      <summary>Band Tweaks (NEW model) — £ add by miles band (applied ≤ 10 miles)</summary>
      <div class="grid" style="grid-template-columns:repeat(5,1fr);margin-top:8px">
        <div><label>Rate</label>
          <select id="bandRateSel">
            <option value="rate1" selected>Rate 1</option>
            <option value="rate2">Rate 2</option>
            <option value="rate3">Rate 3</option>
          </select>
        </div>
        <div><label>0–1 (£)</label>   <input class="band rate1" data-band="0" type="number" step="0.20" value="0"></div>
        <div><label>1–2 (£)</label>   <input class="band rate1" data-band="1" type="number" step="0.20" value="0"></div>
        <div><label>2–3 (£)</label>   <input class="band rate1" data-band="2" type="number" step="0.20" value="0"></div>
        <div><label>3–4 (£)</label>   <input class="band rate1" data-band="3" type="number" step="0.20" value="0"></div>
        <div><label>4–5 (£)</label>   <input class="band rate1" data-band="4" type="number" step="0.20" value="0"></div>
        <div><label>5–6 (£)</label>   <input class="band rate1" data-band="5" type="number" step="0.20" value="0"></div>
        <div><label>6–7 (£)</label>   <input class="band rate1" data-band="6" type="number" step="0.20" value="0"></div>
        <div><label>7–8 (£)</label>   <input class="band rate1" data-band="7" type="number" step="0.20" value="0"></div>
        <div><label>8–9 (£)</label>   <input class="band rate1" data-band="8" type="number" step="0.20" value="0"></div>
        <div><label>9–10 (£)</label>  <input class="band rate1" data-band="9" type="number" step="0.20" value="0"></div>
      </div>
      <div class="tiny">Tip: switch the “Rate” dropdown to R2/R3 to edit those bands. Values are saved per rate during the session.</div>
    </details>
  </div>

  <!-- Data entry -->
  <div class="card">
    <div class="grid inputs">
      <div>
        <label>Paste CSV (minutes,miles,meter) — one per line</label>
        <textarea id="pasteBox" placeholder="e.g. 29,6.3,35.80&#10;43,6.0,44.40&#10;38,6.0,41.20&#10;30,6.0,35.40"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="addPasted">Add pasted rows</button>
          <button class="btn gray" id="clearAll">Clear table</button>
          <button class="btn alt" id="exportBtn">Export CSV</button>
        </div>
        <div class="tiny">Over = blue (estimator &gt; meter). Under = red (estimator &lt; meter). |Δ| ≤ tolerance = black.</div>
      </div>
      <div>
        <label>Quick add (one row)</label>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
          <div><input id="qMin" type="number" step="1" placeholder="Minutes"></div>
          <div><input id="qMi" type="number" step="0.1" placeholder="Miles"></div>
          <div><input id="qMeter" type="number" step="0.01" placeholder="Meter £"></div>
        </div>
        <button class="btn" id="addOne" style="margin-top:8px">Add row</button>
        <p class="mono" style="margin-top:10px;color:#555">Paste only minutes,miles,meter — everything else is auto.</p>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="max-height:65vh;overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Minutes</th>
          <th>Miles</th>
          <th>Meter</th>
          <th>OLD: Scalable core</th>
          <th>Δ vs Meter (OLD)</th>
          <th>NEW: Scalable + BandTweaks</th>
          <th>Δ vs Meter (NEW)</th>
          <th>Δ (NEW−OLD)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const r2 = x => Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const floorTo = (x,inc)=>Math.floor(x/inc)*inc;
const ceilTo  = (x,inc)=>Math.ceil (x/inc)*inc;

/* ===== Fare increment & range (for display bounds if you need later) ===== */
const INC = 0.20;

/* ===== Minute tiers & per-mile bands (as before) ===== */
const MODEL = {
  baseFare: 4.20,
  rate1:{
    perMinute:[ {upTo:6,v:0.29},{upTo:12,v:0.34},{upTo:25,v:0.38},{v:0.46} ],
    perMile:[ {mMax:2.0, v:3.60},{mMin:2.0,mMax:3.5, v:3.75},{mMin:3.5,mMax:4.8, v:3.90},{mMin:4.8,mMax:7.0, v:4.00},{mMin:7.0,mMax:15, v:4.08},{mMin:15,mMax:25, v:3.95},{v:3.80} ]
  },
  rate2:{
    perMinute:[ {upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60} ],
    perMile:[ {mMax:1.0, v:3.60},{mMin:1.0,mMax:2.2, v:3.75},{mMin:2.2,mMax:3.5, v:3.95},{mMin:3.5,mMax:4.6, v:4.15},{mMin:4.6,mMax:7.5, v:4.35},{mMin:7.5,mMax:10, v:4.05},{mMin:10, v:4.10} ]
  },
  rate3:{
    perMinute:[ {upTo:10,v:0.60},{upTo:20,v:0.64},{upTo:35,v:0.55},{v:0.45} ],
    perMile:[ {mMax:3.0, v:3.95},{mMin:3.0,mMax:5.0, v:3.65},{mMin:5.0,mMax:6.5, v:3.40},{mMin:6.6,mMax:9.0, v:3.20},{v:3.10} ],
    r3Extra:true // keep the 3–7 mi, >30 min uplift behaviour you validated before
  }
};

/* ===== Uplifts (your switches) ===== */
function getUplifts(){
  const baseFare = Number($('baseFare').value)||MODEL.baseFare;
  const g  = (Number($('upliftGlobal').value)||0)/100 + 1;
  const r1 = (Number($('upliftR1').value)||0)/100 + 1;
  const r2 = (Number($('upliftR2').value)||0)/100 + 1;
  const r3 = (Number($('upliftR3').value)||0)/100 + 1;
  const r4 = (Number($('upliftR4').value)||0)/100 + 1;
  const t4Miles = Number($('t4Miles').value)||6.0;
  const t4Align = $('t4Align').value==='on';
  return {baseFare, mul:{rate1:r1,rate2:r2,rate3:r3,global:g}, rate4:{align:t4Align, miles:t4Miles, mul:r4}};
}

/* ===== Per-minute and per-mile helpers ===== */
function minuteCost(tiers, mins, mul){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    const up = t.upTo==null ? Infinity : t.upTo;
    const span = Math.max(0, Math.min(rem, up-used));
    sum += span * (t.v*mul);
    rem -= span; used += span; if(rem<=0) break;
  }
  return sum;
}
function perMileRate(rules, miles){
  const r = rules.find(x=>{
    const min = x.mMin ?? -Infinity;
    const max = x.mMax ?? Infinity;
    return miles>=(min) && miles<=(max);
  }) || rules[rules.length-1];
  return r.v;
}

/* ===== Old Scalable core =====
   - Base fare + (per-minute * Global*RateX) + (per-mile * Global*RateX) * miles
   - If Rate-4 align ON and miles ≥ threshold: per-mile uses Rate-2 bands with extra Rate-4 multiplier
   - Keep Rate-3 extra uplift (3–7 mi & mins>30)
*/
function coreOld(rateKey, mins, miles){
  const U = getUplifts();
  const mul = (U.mul[rateKey]||1) * (U.mul.global||1);

  const mPart = minuteCost(MODEL[rateKey].perMinute, mins, mul);

  let pmRules = MODEL[rateKey].perMile;
  let pmMul   = mul;
  if(U.rate4.align && miles >= U.rate4.miles){
    pmRules = MODEL.rate2.perMile; // align to Rate-2 per-mile
    pmMul   = (U.mul.rate2||1) * (U.mul.global||1) * (U.rate4.mul||1);
  }
  const miRate = perMileRate(pmRules, miles) * pmMul;
  let core = U.baseFare + mPart + miRate*miles;

  // Optional R3 extra (keep prior behaviour you validated)
  if(rateKey==='rate3' && MODEL.rate3.r3Extra && miles>=3 && miles<=7 && mins>30){
    const k = 0.20 + 0.015*miles;
    core += roundTo(k * (mins - 30), INC);
  }

  return roundTo(core, INC);
}

/* ===== Band Tweaks storage (per rate, 10 bands) ===== */
const bandState = {
  rate1: Array(10).fill(0),
  rate2: Array(10).fill(0),
  rate3: Array(10).fill(0)
};
function bandIndexForMiles(m){
  if(m<0) return -1;
  const i = Math.floor(m); // 0–0.999→0, 1–1.999→1, ..., 9–9.999→9
  return (i>=0 && i<=9) ? i : -1;
}

/* ===== New core (Old + per-band additive tweak ≤10 mi) ===== */
function coreNew(rateKey, mins, miles){
  const base = coreOld(rateKey, mins, miles);
  const idx = bandIndexForMiles(miles);
  if(idx<0) return base; // >10 miles → keep “what worked”
  const add = Number((bandState[rateKey]||[])[idx]) || 0;
  return roundTo(base + add, INC);
}

/* ===== UI: Band controls replicate per rate ===== */
function refreshBandInputs(){
  const rate = $('bandRateSel').value;
  const inputs = document.querySelectorAll('input.band');
  inputs.forEach(el=>{
    const i = Number(el.dataset.band);
    el.value = (bandState[rate][i] ?? 0);
    // toggle visible class to show only the selected rate’s row
    inputs.forEach(x=>x.classList.toggle('hidden', false));
  });
  // Show labels reflect selected rate (using classes)
  document.querySelectorAll('.band').forEach(el=>{
    el.style.display = el.classList.contains(rate) ? '' : 'none';
  });
}
$('bandRateSel').addEventListener('input', refreshBandInputs);
document.addEventListener('input', (e)=>{
  if(!e.target.classList.contains('band')) return;
  const rate = $('bandRateSel').value;
  const idx = Number(e.target.dataset.band);
  bandState[rate][idx] = Number(e.target.value)||0;
  recalcAndRender();
});

/* ===== App state + CSV handling ===== */
let rows = []; // {mins, miles, meter}
function parseCSV(text){
  const out=[];
  text.split(/\r?\n/).forEach(line=>{
    const s=line.trim(); if(!s) return;
    const parts=s.split(',').map(x=>x.trim());
    if(parts.length<3) return;
    const [mStr, miStr, meStr] = parts;
    const mins = Number(mStr), miles = Number(miStr), meter = Number(String(meStr).replace('£',''));
    if(Number.isFinite(mins)&&Number.isFinite(miles)&&Number.isFinite(meter)) out.push({mins,miles,meter});
  });
  return out;
}
function classify(err, tol){ if(Math.abs(err)<=tol) return 'near'; return err>0?'over':'under'; }

/* ===== Recalc + Render ===== */
function recalcAndRender(){
  const tol = Number($('tol').value)||0.60;
  const rate = $('rateSel').value;
  const sort = $('sortSel').value;

  const computed = rows.map((r,i)=>{
    const oldC = coreOld(rate, r.mins, r.miles);
    const newC = coreNew(rate, r.mins, r.miles);
    const errO = r2(oldC - r.meter);
    const errN = r2(newC - r.meter);
    return {
      idx:i+1, ...r,
      oldC, errO,
      newC, errN,
      delta: r2(newC - oldC)
    };
  });

  let view = computed;
  if(sort==='old_asc')  view = [...view].sort((a,b)=>Math.abs(a.errO)-Math.abs(b.errO));
  if(sort==='old_desc') view = [...view].sort((a,b)=>Math.abs(b.errO)-Math.abs(a.errO));
  if(sort==='new_asc')  view = [...view].sort((a,b)=>Math.abs(a.errN)-Math.abs(b.errN));
  if(sort==='new_desc') view = [...view].sort((a,b)=>Math.abs(b.errN)-Math.abs(a.errN));

  const tb = $('tbody'); tb.innerHTML='';
  for(const r of view){
    const clsO = classify(r.errO, tol);
    const clsN = classify(r.errN, tol);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${r.idx}</td>
      <td>${r.mins}</td>
      <td>${r.miles.toFixed(1)}</td>
      <td class="mono">£${r.meter.toFixed(2)}</td>

      <td class="mono">£${r.oldC.toFixed(2)}</td>
      <td class="mono ${clsO}">${r.errO>0?'+':''}${r.errO.toFixed(2)}</td>

      <td class="mono">£${r.newC.toFixed(2)}</td>
      <td class="mono ${clsN}">${r.errN>0?'+':''}${r.errN.toFixed(2)}</td>

      <td class="mono">${r.delta>0?'+':''}${r.delta.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  }
}

/* ===== Wire up buttons ===== */
$('addPasted').addEventListener('click', ()=>{
  const arr = parseCSV($('pasteBox').value);
  rows = rows.concat(arr);
  $('pasteBox').value='';
  recalcAndRender();
});
$('addOne').addEventListener('click', ()=>{
  const mins = Number($('qMin').value);
  const miles = Number($('qMi').value);
  const meter = Number($('qMeter').value);
  if(Number.isFinite(mins)&&Number.isFinite(miles)&&Number.isFinite(meter)){
    rows.push({mins,miles,meter});
    $('qMin').value=$('qMi').value=$('qMeter').value='';
    recalcAndRender();
  }
});
['rateSel','baseFare','upliftGlobal','upliftR1','upliftR2','upliftR3','upliftR4','t4Miles','t4Align','tol','sortSel']
.forEach(id=>$(id).addEventListener('input', recalcAndRender));

$('clearAll').addEventListener('click', ()=>{ rows=[]; recalcAndRender(); });

$('exportBtn').addEventListener('click', ()=>{
  const tol = Number($('tol').value)||0.60;
  const rate = $('rateSel').value;
  const U = getUplifts();
  const th = ["minutes","miles","meter",
              "core_old","diff_old",
              "core_new","diff_new",
              "delta_new_minus_old",
              "rate","baseFare","upliftGlobal","upliftR1","upliftR2","upliftR3",
              "t4Align","t4Miles","upliftR4","tolerance",
              "bands_rate1","bands_rate2","bands_rate3"];
  const out = rows.map(r=>{
    const oldC = coreOld(rate, r.mins, r.miles);
    const newC = coreNew(rate, r.mins, r.miles);
    const errO = r2(oldC - r.meter), errN = r2(newC - r.meter);
    return [r.mins,r.miles,r.meter,
            oldC,errO,
            newC,errN,
            r2(newC - oldC),
            rate,U.baseFare,U.mul.global, U.mul.rate1, U.mul.rate2, U.mul.rate3,
            U.rate4.align, U.rate4.miles, U.rate4.mul, tol,
            JSON.stringify(bandState.rate1), JSON.stringify(bandState.rate2), JSON.stringify(bandState.rate3)
    ];
  });
  const csv = [th.join(',')].concat(out.map(a=>a.join(','))).join('\r\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='cabwizz_dual_tester_v5_old_vs_new.csv'; a.click(); URL.revokeObjectURL(a.href);
});

/* ===== Init ===== */
refreshBandInputs();
recalcAndRender();
</script>
</body>
</html>
