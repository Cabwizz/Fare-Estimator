<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a7">
  <title>CabWizz Fare Estimator — v3.4 (R1/R2/R3 tuned)</title>
  <style>
    :root{--ok:#0a7;--warn:#f8a100;--info:#1869ff;--danger:#d33;--stroke:#d1d1d6}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:12px;line-height:1.25;background:#f7f7f8;color:#111}
    h1{font-size:18px;margin:0 0 8px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .badge{background:#e5f6ef;color:#045a36;font-size:11px;padding:2px 8px;border-radius:999px}
    .card{border:1px solid #e5e5ea;border-radius:16px;padding:14px;margin:10px 0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    label{display:block;font-size:14px;margin:10px 0 6px;color:#333}
    input,button{font-size:16px;padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);width:100%;background:#fff}
    input::placeholder{color:#b0b0b5}
    .row{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:420px){ .row,.row3{grid-template-columns:1fr} }
    .timeRow input[type="time"]{-webkit-appearance:none;appearance:none;text-align:center;font-variant-numeric:tabular-nums;line-height:1;min-height:48px}
    .timeRow .cell{display:flex;align-items:center}
    .timeRow .cell input{width:100%}
    .out{font-weight:700}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .muted{color:#666}
    .btns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .btn{border:none;color:#fff;font-weight:600;text-align:center;border-radius:16px;padding:14px;width:100%;box-shadow:0 1px 0 rgba(0,0,0,.08), inset 0 -1px 0 rgba(0,0,0,.08)}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .info{background:var(--info)} .danger{background:var(--danger)}
    .btn.outline-danger{background:#fff;color:var(--danger);border:1px solid var(--danger);box-shadow:none}
    .btn.outline{background:#fff;color:#333;border:1px solid var(--stroke);box-shadow:none}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
    th{background:#fafafa;position:sticky;top:0}
    .tiny{color:#888;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <h1>
    CabWizz Fare Estimator
    <span class="badge" id="appVersion">v3.4 (R1/R2/R3 tuned)</span>
  </h1>

  <div class="card">
    <!-- Times -->
    <div class="row timeRow">
      <div class="cell"><div style="width:100%">
        <label for="tStart">Start time</label>
        <input id="tStart" type="time" step="60" />
      </div></div>
      <div class="cell"><div style="width:100%">
        <label for="tEnd">End time</label>
        <input id="tEnd" type="time" step="60" />
      </div></div>
    </div>

    <!-- Mileages -->
    <div class="row">
      <div>
        <label for="miStart">Start mileage</label>
        <input id="miStart" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 12034.5" />
      </div>
      <div>
        <label for="miEnd">End mileage</label>
        <input id="miEnd" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 12040.1" />
      </div>
    </div>

    <!-- Manual minutes/miles -->
    <div class="row" style="margin-top:6px">
      <div>
        <label for="mins">Minutes</label>
        <input id="mins" type="number" inputmode="numeric" step="1" min="0" placeholder="e.g. 17" />
      </div>
      <div>
        <label for="miles">Miles</label>
        <input id="miles" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 2.8" />
      </div>
    </div>

    <!-- Meter -->
    <div style="margin-top:10px">
      <label for="meter">Actual meter fare (optional)</label>
      <input id="meter" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 17.40" />
    </div>

    <!-- Outputs -->
    <div class="row3" style="margin-top:12px">
      <div><div class="muted">Rate 1</div><div class="out mono" id="r1">–</div></div>
      <div><div class="muted">Rate 2</div><div class="out mono" id="r2">–</div></div>
      <div><div class="muted">Rate 3</div><div class="out mono" id="r3">–</div></div>
    </div>

    <!-- Buttons -->
    <div class="btns">
      <button class="btn ok" id="calcBtn">Calculate</button>
      <button class="btn warn" id="saveBtn">Save Journey</button>
      <button class="btn info" id="exportBtn">Export CSV</button>
      <button class="btn outline" id="resetBtn">Reset Fields</button>
      <button class="btn outline-danger" id="delPrevBtn">Delete Previous</button>
      <button class="btn danger" id="clearBtn">Clear Log</button>
    </div>
    <div class="tiny">Add to Home Screen for offline. Inputs auto-save.</div>
  </div>

  <div class="card">
    <div class="muted">Saved Journeys</div>
    <div style="max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:12px; margin-top:6px">
      <table id="logTbl">
        <thead>
          <tr>
            <th>#</th><th>When</th><th>Min</th><th>Mi</th>
            <th>Rate 1 (core/range)</th><th>Rate 2 (core/range)</th><th>Rate 3 (core/range)</th><th>Meter</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const APP_VERSION = 'v3.4 (R1/R2/R3 tuned)';

const cfg = {
  baseFare: 4.20,
  inc: 0.20,

  // global range bands (kept)
  rangeBands: [
    { max: 1.5, lower:{fixed:0.30,pct:0.02}, upper:{fixed:0.60,pct:0.05} },
    { max: 2.5, lower:{fixed:0.60,pct:0.04}, upper:{fixed:1.00,pct:0.06} },
    { max: 4.5, lower:{fixed:1.00,pct:0.04}, upper:{fixed:1.60,pct:0.06} },
    { max: 6.5, lower:{fixed:1.60,pct:0.04}, upper:{fixed:2.00,pct:0.05} },
    { max: 1e9, lower:{fixed:2.00,pct:0.02}, upper:{fixed:2.50,pct:0.04} },
  ],

  /* --- Rate 1 (R1_FIX_2025_11_05) --- */
  rate1:{
    perMinute:[
      { upTo: 6,  v: 0.29 },
      { upTo: 12, v: 0.34 },
      { upTo: 25, v: 0.38 },
      { v: 0.46 }
    ],
    perMileRules:[
      { when:{ mMax:2.0 }, v:3.60 },
      { when:{ mMin:2.0, mMax:3.5 }, v:3.75 },
      { when:{ mMin:3.5, mMax:4.8 }, v:3.90 },
      { when:{ mMin:4.8, mMax:7.0 }, v:4.00 },
      { when:{ mMin:7.0, mMax:15 }, v:4.08 },
      { when:{ mMin:15,  mMax:25 }, v:3.95 },
      { v:3.80 }
    ],
    offsets:[
      { when:{ mMax:2.2, tMin:12, tMax:20 }, d: 1.20 },
      { when:{ mMin:1.6, mMax:2.0, tMin:18, tMax:22 }, d: 2.00 },
      { when:{ mMin:3.8, mMax:4.2, tMin:20, tMax:24 }, d:-1.00 }
    ],
    longTrim:{ enabled:true, when:{ mMin:35, tMin:90 }, pct:0.03, minAbs:2.00 }
  },

  /* --- Rate 2 (R2_FIX_2025_11_05, with slow-short uplift) --- */
  rate2:{
    perMinute:[ {upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60} ],
    perMileRules:[
      { when:{ mMax:1.0 }, v:3.60 },
      { when:{ mMin:1.0, mMax:2.2 }, v:3.75 },
      { when:{ mMin:2.2, mMax:3.5 }, v:3.95 },
      { when:{ mMin:3.5, mMax:4.6 }, v:4.15 },
      { when:{ mMin:4.6, mMax:7.5 }, v:4.35 },
      { when:{ mMin:7.5, mMax:10 }, v:4.05 },
      { when:{ mMin:10 }, v:4.10 }
    ],
    offsets:[
      // short & slow (fix 21m @1.8 deficit etc.)
      { when:{ mMin:1.7, mMax:1.9, tMin:20, tMax:22 }, d: 5.00 },
      { when:{ mMin:1.5, mMax:2.0, tMin:12, tMax:18 }, d: 1.20 },

      // mid softeners where we saw overestimates
      { when:{ mMin:6.0, mMax:7.0, tMin:26, tMax:35 }, d:-1.40 },
      { when:{ mMin:7.5, mMax:10.0, tMin:40, tMax:55 }, d:-1.20 },

      // tiny-trip tidy
      { when:{ mMax:0.8, tMax:5 }, d:-0.40 }
    ],
    longTrim:{ enabled:true, when:{ mMin:25, tMin:65 }, pct:0.05, minAbs:3.50 }
  },

  /* --- Rate 3 (R3 tuned v3.4) --- */
  rate3: {
    // minutes: boost short-slow, flatten mid a touch
    perMinute: [
      { upTo: 10, v: 0.60 },
      { upTo: 20, v: 0.64 },
      { upTo: 35, v: 0.55 },
      { v: 0.45 }
    ],
    perMileRules: [
      { when:{ mMax:3.0 }, v: 3.95 },                        // 0–3 mi
      { when:{ mMin:3.0, mMax:5.0 }, v: 3.65 },              // 3–5 mi
      { when:{ mMin:5.0, mMax:6.5 }, v: 3.40 },              // 5–6.5 mi (soften)
      { when:{ mMin:6.6, mMax:9.0 }, v: 3.20 },              // 6.6–9.0 mi (further soften)
      { v: 3.10 }                                            // 9.1+ mi
    ],
    offsets:[
      // Fix short slow journeys (under-valued)
      { when:{ mMin:1.5, mMax:1.9, tMin:18, tMax:25 }, d: 6.00 },
      { when:{ mMin:2.0, mMax:2.3, tMin:12, tMax:18 }, d: 5.00 },

      // Trim long mid-band (over-valued 6–9 mi @ ~30–40m)
      { when:{ mMin:6.0, mMax:7.0, tMin:25, tMax:35 }, d: -3.00 },
      { when:{ mMin:7.5, mMax:9.2, tMin:26, tMax:38 }, d: -5.00 },

      // Minor edge smoothing you liked
      { when:{ mMax:0.8, tMax:5 }, d:-0.40 },
      { when:{ mMin:9.5, mMax:10.5, tMin:40, tMax:50 }, d:1.20 }
    ],
    longTrim:{ enabled:true, when:{ mMin:25, tMin:65 }, pct:0.05, minAbs:3.50 }
  }
};

/* ========= helpers ========= */
const r2 = (x)=>Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const floorTo  = (x,inc)=>Math.floor(x/inc)*inc;
const ceilTo   = (x,inc)=>Math.ceil (x/inc)*inc;
const $ = (id)=>document.getElementById(id);

/* ========= persist ========= */
const FORM_KEY='cabwizz_form_v1';
const FORM_IDS=['tStart','tEnd','miStart','miEnd','mins','miles','meter'];
function saveForm(){ const o={}; FORM_IDS.forEach(id=>o[id]=$(id).value??''); localStorage.setItem(FORM_KEY, JSON.stringify(o)); }
function loadForm(){ try{ const raw=localStorage.getItem(FORM_KEY); if(!raw) return; const o=JSON.parse(raw); FORM_IDS.forEach(id=>{ if(o[id]!==undefined) $(id).value=o[id]; }); }catch(e){} }
function clearForm(){ FORM_IDS.forEach(id=>$(id).value=''); saveForm(); }

/* ========= rule helpers ========= */
function matches(w, miles, mins){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  if(w.tMin!==undefined && mins  < w.tMin) return false;
  if(w.tMax!==undefined && mins  > w.tMax) return false;
  return true;
}
function pickPerMile(rules, miles, mins){
  const r = rules.find(x=>matches(x.when,miles,mins));
  return (r||rules[rules.length-1]).v;
}
function minutePart(tiers, mins){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    if(t.upTo==null){ sum+=rem*t.v; break; }
    const span=Math.max(0, Math.min(rem, t.upTo-used));
    sum += span*t.v; rem-=span; used+=span;
    if(rem<=0) break;
  }
  return sum;
}
function sumOffsets(arr, miles, mins){
  return (arr||[]).reduce((s,o)=>s+(matches(o.when,miles,mins)?o.d:0),0);
}

/* ========= range builder (with tolerance clamp) ======== */
function baseBand(miles){
  return cfg.rangeBands.find(x=>miles<=x.max) || cfg.rangeBands[cfg.rangeBands.length-1];
}
function clampByFareSize(core, lower, upper){
  if(core <= 20){
    lower = Math.min(lower, core - 1.00);
    upper = Math.max(upper, core + 1.00);
  } else if(core <= 40){
    lower = Math.min(lower, core - 1.20);
    upper = Math.max(upper, core + 1.20);
  } else if(core <= 60){
    lower = Math.min(lower, core - 1.40);
    upper = Math.max(upper, core + 1.40);
  } else {
    lower = Math.min(lower, core - 1.60);
    upper = Math.max(upper, core + 1.60);
  }
  return {lower, upper};
}
function buildRange(core, miles, mins){
  const b = baseBand(miles);
  let lowerAdj = Math.max(b.lower.fixed, core*b.lower.pct);
  let upperAdj = Math.max(b.upper.fixed, core*b.upper.pct);

  // very short (≤1.0 mi): keep tight-ish
  if(miles<=1.0){
    lowerAdj = Math.min(lowerAdj, 1.00);
    upperAdj = Math.min(Math.max(upperAdj, 1.20), 1.80);
  }

  // time-heavy short trips (≤2.5 mi & ≥15 min): widen a touch
  if(miles<=2.5 && mins>=15){
    lowerAdj = Math.max(lowerAdj*1.05, lowerAdj+0.30);
    upperAdj = Math.max(upperAdj*1.20, upperAdj+0.80);
  }

  // long & slow (≥6 mi & ≥35 min): more upper room
  if(miles>=6 && mins>=35){
    upperAdj = Math.max(upperAdj*1.12, upperAdj+0.80);
  }

  let lower = floorTo(roundTo(core - lowerAdj, cfg.inc), cfg.inc);
  let upper = ceilTo (roundTo(core + upperAdj, cfg.inc), cfg.inc);

  // clamp to global tolerance
  const clamped = clampByFareSize(core, lower, upper);
  lower = clamped.lower;
  upper = clamped.upper;

  // absolute floor for tiny trips
  if(miles<=0.8){
    const absFloor = 6.20;
    if(lower < absFloor) lower = roundTo(absFloor, cfg.inc);
  }
  return {lower, upper};
}

/* ========= long-trim ========= */
function longTrim(core, trim, miles, mins){
  if(!trim||!trim.enabled) return core;
  if(!matches(trim.when,miles,mins)) return core;
  const rounded = roundTo(core, cfg.inc);
  const dec = Math.max(trim.minAbs, roundTo(rounded*trim.pct, cfg.inc));
  return roundTo(rounded - dec, cfg.inc);
}

/* ========= start/end helpers ========= */
function parseTimeToMinutes(t){
  if(!t || !/^\d{2}:\d{2}$/.test(t)) return null;
  const [H,M] = t.split(':').map(Number);
  return H*60 + M;
}
function computeFromStartEnd(){
  const tS = parseTimeToMinutes($('tStart').value);
  const tE = parseTimeToMinutes($('tEnd').value);
  if(tS!=null && tE!=null){
    let diff = tE - tS;
    if(diff < 0) diff += 24*60;
    $('mins').value = String(Math.max(0, Math.round(diff)));
  }
  const ms = Number($('miStart').value);
  const me = Number($('miEnd').value);
  if(!Number.isNaN(ms) && !Number.isNaN(me) && $('miStart').value!=='' && $('miEnd').value!==''){
    const m = Math.max(0, r2(me - ms));
    $('miles').value = String(m);
  }
  saveForm();
}

/* ========= fare core ========= */
function estimate(rateKey, mins, miles){
  const r = cfg[rateKey];
  const mPart = minutePart(r.perMinute, mins);
  const perMile = pickPerMile(r.perMileRules, miles, mins);
  let core = cfg.baseFare + mPart + perMile*miles + sumOffsets(r.offsets, miles, mins);

  // (Keep) rate3 extra minute uplift for 3–7 mi, >30m
  if (rateKey==='rate3' && miles>=3 && miles<=7 && mins>30){
    const k = 0.20 + 0.015*miles;
    const extra = roundTo(k * (mins - 30), cfg.inc);
    core += extra;
  }

  if(r.longTrim) core = longTrim(core, r.longTrim, miles, mins);

  core = roundTo(core, cfg.inc);
  const rng = buildRange(core, miles, mins);
  return { core, lower:rng.lower, upper:rng.upper };
}

/* ========= export/log stuff ========= */
const KEY='cabwizz_log_v1';
function loadLog(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return [] } }
function saveLog(rows){ localStorage.setItem(KEY, JSON.stringify(rows)); renderLog(); }
function renderLog(){
  const body = $('logBody'); body.innerHTML='';
  const rows = loadLog();
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td><td class="mono">${r.when}</td>
      <td>${r.mins}</td><td>${r.miles}</td>
      <td class="mono">${r.r1}</td><td class="mono">${r.r2}</td><td class="mono">${r.r3}</td>
      <td>${r.meter? '£'+Number(r.meter).toFixed(2):''}</td>`;
    body.appendChild(tr);
  });
}
function weekdayStamp(d=new Date()){
  const wk=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
  const pad=n=>String(n).padStart(2,'0');
  return `${wk} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function fmt(x){ return '£'+r2(x).toFixed(2); }
function fmtRange(core,lo,hi){ return `${fmt(core)}  (${fmt(lo)}–${fmt(hi)})`; }

function exportCSV(){
  const rows = loadLog();
  const head = ['When','Minutes','Miles','Core/Range','Meter','Rate','Note','Start','End'];
  const out = [head];
  rows.forEach(r=>{
    out.push([ r.when, r.mins, r.miles, r.coreRangeForRate||'', r.meter||'', r.rateNow||'', r.note||'', r.start||'', r.end||'' ]);
    if(r.crossed && r.endRate && r.endRate!==r.rateNow){
      out.push([ r.when, r.mins, r.miles, '', r.meter||'', r.endRate, `Crossover ${r.rateNow}→${r.endRate}`, r.start||'', r.end||'' ]);
    }
  });
  const csv = out.map(arr=>arr.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='cabwizz_journeys.csv'; a.click(); URL.revokeObjectURL(a.href);
}

/* ========= rate time-of-day (kept) ========= */
function rateNowLabelFor(startMinutes, weekday){
  const m = startMinutes; if(m==null) return 'Rate 1';
  const inR=(a,b)=> (m>=a && m<b); const R1='Rate 1',R2='Rate 2',R3='Rate 3';
  if(weekday>=1 && weekday<=5){ if(inR(300,1200)) return R1; if(inR(1200,1320)) return R2; return R3; }
  if(weekday===6){ if(inR(300,1320)) return R2; return R3; }
  if(weekday===0){ if(inR(300,1320)) return R2; return R3; }
  return R1;
}
function endRateLabelFor(startMin,endMin,weekday){
  let endWeekday = weekday;
  if(endMin<startMin) endWeekday = (weekday+1)%7;
  return rateNowLabelFor(endMin, endWeekday);
}

/* ========= calculate & render ========= */
function refresh(){
  computeFromStartEnd();
  const mins = Number($('mins').value);
  const miles= Number($('miles').value);
  if(Number.isNaN(mins)||Number.isNaN(miles)) return;

  const r1 = estimate('rate1', mins, miles);
  const r2 = estimate('rate2', mins, miles);
  const r3 = estimate('rate3', mins, miles);

  $('r1').textContent = fmtRange(r1.core, r1.lower, r1.upper);
  $('r2').textContent = fmtRange(r2.core, r2.lower, r2.upper);
  $('r3').textContent = fmtRange(r3.core, r3.lower, r3.upper);

  return {mins, miles, r1, r2, r3};
}

/* ========= events ========= */
window.addEventListener('load', ()=>{
  loadForm();
  computeFromStartEnd();
  renderLog();
  const el = document.getElementById('appVersion');
  if(el) el.textContent = APP_VERSION;
});
document.getElementById('calcBtn').addEventListener('click', refresh);
['tStart','tEnd','miStart','miEnd','mins','miles','meter'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    if(id==='tStart'||id==='tEnd'||id==='miStart'||id==='miEnd') computeFromStartEnd(); else saveForm();
  });
});
document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset all input fields?')) clearForm(); });
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const res = refresh(); if(!res) return;
  const now = new Date();
  const whenStr = weekdayStamp(now);
  const tStartStr = $('tStart').value || '';
  const tEndStr   = $('tEnd').value   || '';
  const startMin = parseTimeToMinutes(tStartStr);
  const endMin   = parseTimeToMinutes(tEndStr);
  const weekday  = now.getDay();

  const rateNow = rateNowLabelFor(startMin, weekday);
  const endRate = (endMin!=null && startMin!=null) ? endRateLabelFor(startMin, endMin, weekday) : rateNow;
  const crossed = (endRate !== rateNow);

  const chosen = rateNow==='Rate 1' ? res.r1 : rateNow==='Rate 2' ? res.r2 : res.r3;
  const coreRangeForRate = `${fmt(chosen.core)} (${fmt(chosen.lower)}–${fmt(chosen.upper)})`;

  const meter = $('meter').value;

  const row = {
    when: whenStr,
    mins: res.mins, miles: res.miles,
    r1: fmtRange(res.r1.core,res.r1.lower,res.r1.upper),
    r2: fmtRange(res.r2.core,res.r2.lower,res.r2.upper),
    r3: fmtRange(res.r3.core,res.r3.lower,res.r3.upper),
    meter: meter? Number(meter).toFixed(2):'',
    rateNow, coreRangeForRate, crossed, start: tStartStr, end: tEndStr, endRate
  };
  const rows = loadLog(); rows.push(row); saveLog(rows);
  $('meter').value=''; saveForm();
});
document.getElementById('delPrevBtn').addEventListener('click', ()=>{
  const rows = loadLog();
  if(!rows.length) return;
  if(confirm('Delete the most recent saved journey?')){ rows.pop(); saveLog(rows); }
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  const rows = loadLog();
  if(!rows.length) return;
  if(confirm('Clear ALL saved journeys?')){ saveLog([]); }
});
document.getElementById('exportBtn').addEventListener('click', exportCSV);

/* ========= PWA ========= */
if (location.protocol.startsWith('http') && 'serviceWorker' in navigator) {
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('sw.js').catch(console.warn);
  });
}
</script>
</body>
</html>
