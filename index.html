<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CabWizz Fare Estimator</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#16a34a">

<style>
  *,*::before,*::after{box-sizing:border-box}
  body{margin:16px;background:#f6f7f9;line-height:1.25;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  h1{font-size:20px;margin:0 0 10px;text-align:left}
  .card{background:#fff;border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px auto;max-width:900px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  label{display:block;font-size:14px;margin:8px 0 4px}
  input,button{width:100%;font-size:16px;padding:12px;border-radius:12px;border:1px solid #cfcfcf;background:#fff;appearance:none}
  input[readonly]{background:#f9fafb;color:#444}
  input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  .btns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .btn-green{background:#16a34a;border-color:#16a34a;color:#fff}
  .btn-orange{background:#f59e0b;border-color:#f59e0b;color:#fff}
  .btn-blue{background:#2563eb;border-color:#2563eb;color:#fff}
  .btn-red{background:#ef4444;border-color:#ef4444;color:#fff}
  .btn-gray{background:#6b7280;border-color:#6b7280;color:#fff}
  .muted{color:#666}
  .out{font-weight:800}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0;z-index:1}
  .footer{color:#888;font-size:12px;margin-top:8px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa;font-size:12px;margin-left:6px}
</style>
</head>
<body>
<h1>CabWizz Fare Estimator <span class="pill mono" id="activeRatePill">Active: –</span></h1>

<div class="card">
  <div class="row4">
    <div>
      <label for="startTime">Start time</label>
      <input id="startTime" type="time" step="60">
    </div>
    <div>
      <label for="endTime">End time</label>
      <input id="endTime" type="time" step="60">
    </div>
    <div>
      <label for="startOdo">Start odometer (mi)</label>
      <input id="startOdo" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 12456.7">
    </div>
    <div>
      <label for="endOdo">End odometer (mi)</label>
      <input id="endOdo" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 12461.9">
    </div>
  </div>

  <div class="row2" style="margin-top:10px">
    <div>
      <label for="mins">Computed minutes</label>
      <input id="mins" type="number" step="1" readonly placeholder="auto">
    </div>
    <div>
      <label for="miles">Computed miles</label>
      <input id="miles" type="number" step="0.1" readonly placeholder="auto">
    </div>
  </div>

  <div style="margin-top:10px">
    <label for="meter">Actual meter fare (optional)</label>
    <input id="meter" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 17.40">
  </div>

  <div class="btns" style="margin-top:10px">
    <button class="btn-gray" id="resetFieldsBtn">Reset Fields (times/odo/meter)</button>
  </div>

  <div class="row3" style="margin-top:12px">
    <div><div class="muted">Rate 1</div><div class="out mono" id="r1">–</div></div>
    <div><div class="muted">Rate 2</div><div class="out mono" id="r2">–</div></div>
    <div><div class="muted">Rate 3</div><div class="out mono" id="r3">–</div></div>
  </div>

  <div class="btns">
    <button class="btn-green"  id="calcBtn">Calculate</button>
    <button class="btn-orange" id="saveBtn">Save Journey</button>
    <button class="btn-blue"   id="exportBtn">Export CSV</button>
    <button class="btn-red"    id="clearBtn">Clear Log</button>
  </div>

  <div class="footer">Works offline (PWA). Add to Home Screen if you like.</div>
</div>

<div class="card">
  <div class="muted">Saved Journeys</div>
  <div style="max-height:52vh;overflow:auto;border:1px solid #eee;border-radius:10px;margin-top:6px">
    <table>
      <thead>
        <tr>
          <th>#</th><th>When</th><th>Start</th><th>End</th>
          <th>Start mi</th><th>End mi</th><th>Min</th><th>Mi</th>
          <th>Active</th>
          <th>Rate 1 (core / range)</th>
          <th>Rate 2 (core / range)</th>
          <th>Rate 3 (core / range)</th>
          <th>Meter</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Tiny banner so we know JS is running ---
  const ok = document.createElement('div');
  ok.textContent = 'JS OK';
  ok.style.cssText = 'position:fixed;top:8px;right:8px;background:#e6ffed;color:#065f46;border:1px solid #34d399;padding:4px 8px;border-radius:6px;font:12px/1 ui-monospace;z-index:9999';
  document.body.appendChild(ok);
  setTimeout(()=>ok.remove(), 2500);

  /* ===== Service worker (PWA) ===== */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').then(reg => {
        reg.onupdatefound = () => {
          const nw = reg.installing;
          nw && (nw.onstatechange = () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              nw.postMessage({action:'SKIP_WAITING'});
              setTimeout(()=>location.reload(), 300);
            }
          });
        };
      }).catch(console.error);
    });
  }

  /* ===== Error banner (helps on iPhone) ===== */
  window.onerror = function(msg, src, line, col){
    const box=document.createElement('div');
    box.style.cssText='position:fixed;bottom:10px;left:10px;right:10px;background:#fee;border:1px solid #f99;padding:8px;border-radius:8px;color:#900;font:12px ui-monospace;z-index:9999';
    box.textContent='JS error: '+msg+' @ '+(src||'inline')+':'+line+':'+col;
    document.body.appendChild(box);
  };

  // ===== Everything below is your existing logic (unchanged) =====

  /* ===== Rate schedule (weekend + public holidays) ===== */
  const PUBLIC_HOLIDAYS = [ /* "2025-12-25","2025-12-26" */ ];
  function isPublicHoliday(d=new Date()){ return PUBLIC_HOLIDAYS.includes(d.toISOString().slice(0,10)); }
  function parseHM(s){ const [h,m]=s.split(':').map(Number); return h*60+m; }
  function inWindow(t, start, end){ return start<end ? (t>=start && t<end) : (t>=start || t<end); }
  function activeRateName(date=new Date()){
    if (isPublicHoliday(date)) return 'Rate 3';
    const dow=date.getDay(), t=date.getHours()*60+date.getMinutes();
    if (dow>=1 && dow<=4){ // Mon–Thu
      if (inWindow(t,parseHM('05:00'),parseHM('20:00'))) return 'Rate 1';
      if (inWindow(t,parseHM('20:00'),parseHM('22:00'))) return 'Rate 2';
      return 'Rate 3';
    }
    if (dow===5){ // Fri
      if (inWindow(t,parseHM('05:00'),parseHM('20:00'))) return 'Rate 1';
      if (inWindow(t,parseHM('20:00'),parseHM('22:00'))) return 'Rate 2';
      return 'Rate 3';
    }
    if (dow===6){ // Sat
      if (inWindow(t,parseHM('05:00'),parseHM('22:00'))) return 'Rate 2';
      return 'Rate 3';
    }
    // Sun
    if (inWindow(t,parseHM('05:00'),parseHM('17:00'))) return 'Rate 1';
    if (inWindow(t,parseHM('17:00'),parseHM('22:00'))) return 'Rate 2';
    return 'Rate 3';
  }

  /* ===== Config (agreed logic) ===== */
  const cfg = {
    base: 4.20,
    inc : 0.20,
    rangeBands: [
      { max:1.5, lower:{fixed:0.40,pct:0.03}, upper:{fixed:0.80,pct:0.07} },
      { max:2.5, lower:{fixed:0.80,pct:0.05}, upper:{fixed:1.40,pct:0.09} },
      { max:4.5, lower:{fixed:1.60,pct:0.06}, upper:{fixed:2.40,pct:0.09} },
      { max:6.5, lower:{fixed:2.20,pct:0.06}, upper:{fixed:2.80,pct:0.07} },
      { max:1e9, lower:{fixed:2.50,pct:0.03}, upper:{fixed:3.50,pct:0.06} },
    ],
    rate1:{
      perMinute:[{upTo:12,v:0.30},{upTo:25,v:0.34},{v:0.40}],
      perMileRules:[
        {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:3.35},
        {when:{mMax:6.0}, v:3.60},
        {when:{mMin:6.0001}, v:4.15}
      ],
      offsets:[]
    },
    rate2:{
      perMinute:[{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60}],
      perMileRules:[
        {when:{mMin:20.0001}, v:4.15},
        {when:{mMin:7.5}, v:4.15},
        {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:4.05},
        {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, v:3.70},
        {v:4.29}
      ],
      offsets:[
        {when:{mMax:1.2,tMin:6,tMax:13}, d:1.00},
        {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, d:0.40},
        {when:{mMin:18,mMax:21,tMin:45,tMax:60}, d:-2.00},
        {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, d:-2.00}
      ],
      longTrim:{ enabled:true, when:{mMin:20,tMin:55}, pct:0.06, minAbs:4.00 }
    },
    rate3:{
      perMinute:[{upTo:12,v:0.58},{upTo:30,v:0.62},{v:0.44}],
      perMileRules:[
        {when:{mMax:6.0}, v:4.00},
        {when:{mMin:6.0001}, v:4.15}
      ],
      offsets:[
        {when:{mMax:0.5,tMax:5}, d:-1.20},
        {when:{mMax:0.8,tMax:5}, d:-0.60},
        {when:{mMin:1.8,mMax:2.2,tMin:9,tMax:12}, d:-1.40},
        {when:{mMin:5.5,mMax:6.3,tMin:28,tMax:40}, d:-1.60},
        {when:{mMin:18,mMax:20,tMin:45,tMax:60}, d: 1.50}
      ]
    }
  };

  /* ===== Helpers ===== */
  const $       = id => document.getElementById(id);
  const r2      = x => Math.round(x*100)/100;
  const roundTo = (x,i)=> Math.round(x/i)*i;
  const floorTo = (x,i)=> Math.floor(x/i)*i;
  const ceilTo  = (x,i)=> Math.ceil (x/i)*i;
  const £       = n => '£'+r2(n).toFixed(2);

  function matches(w, miles, mins){
    if(!w) return true;
    if(w.mMin!==undefined && miles < w.mMin) return false;
    if(w.mMax!==undefined && miles > w.mMax) return false;
    if(w.tMin!==undefined && mins  < w.tMin) return false;
    if(w.tMax!==undefined && mins  > w.tMax) return false;
    return true;
  }
  function pickPerMile(rules, miles, mins){
    const r = rules.find(x=>matches(x.when,miles,mins));
    return (r||rules[rules.length-1]).v;
  }
  function minutePart(tiers, mins){
    let rem=mins, used=0, sum=0;
    for(const t of tiers){
      if(t.upTo==null){ sum+=rem*t.v; break; }
      const span=Math.max(0,Math.min(rem,t.upTo-used));
      sum+=span*t.v; rem-=span; used+=span; if(rem<=0) break;
    }
    return sum;
  }
  function sumOffsets(arr, miles, mins){
    return (arr||[]).reduce((s,o)=>s+(matches(o.when,miles,mins)?o.d:0),0);
  }
  function longTrim(core, trim, miles, mins){
    if(!trim||!trim.enabled) return core;
    if(!matches(trim.when,miles,mins)) return core;
    const rounded = roundTo(core, cfg.inc);
    const dec = Math.max(trim.minAbs, roundTo(rounded*trim.pct, cfg.inc));
    return roundTo(rounded - dec, cfg.inc);
  }
  function bandFor(miles){
    return cfg.rangeBands.find(x=>miles<=x.max) || cfg.rangeBands.at(-1);
  }
  function rangeAround(core, miles){
    const b = bandFor(miles);
    const lowerAdj = Math.max(b.lower.fixed, core*b.lower.pct);
    const upperAdj = Math.max(b.upper.fixed, core*b.upper.pct);
    return {
      lower: floorTo(roundTo(core - lowerAdj, cfg.inc), cfg.inc),
      upper:  ceilTo(roundTo(core + upperAdj, cfg.inc), cfg.inc)
    };
  }

  /* ===== Compute minutes/miles from inputs ===== */
  function calcMinutes(){
    const s=$('startTime')?.value, e=$('endTime')?.value;
    if(!s || !e) return NaN;
    const today=new Date(); const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
    const ds=new Date(today.getFullYear(),today.getMonth(),today.getDate(),sh,sm,0);
    let   de=new Date(today.getFullYear(),today.getMonth(),today.getDate(),eh,em,0);
    if (de < ds) de = new Date(de.getTime() + 24*60*60*1000);
    return Math.max(0, Math.round((de-ds)/60000));
  }
  function calcMiles(){
    const a=parseFloat($('startOdo')?.value), b=parseFloat($('endOdo')?.value);
    if(Number.isNaN(a) || Number.isNaN(b)) return NaN;
    return Math.max(0, r2(b - a));
  }
  function updateComputedFields(){
    const m = calcMinutes(); if(!Number.isNaN(m)) $('mins').value = m; else $('mins').value='';
    const d = calcMiles();   if(!Number.isNaN(d)) $('miles').value = d; else $('miles').value='';
  }

  /* ===== Core calc (Rate 3 clamp) ===== */
  function estimate(rateKey, mins, miles){
    const r = cfg[rateKey];
    const mPart   = minutePart(r.perMinute, mins);
    const perMile = pickPerMile(r.perMileRules, miles, mins);
    const structural = cfg.base + mPart + perMile*miles;
    let core = structural + sumOffsets(r.offsets, miles, mins);
    if(rateKey==='rate2') core = longTrim(core, r.longTrim, miles, mins);
    if(rateKey==='rate3') core = Math.max(core, structural);
    core = roundTo(core, cfg.inc);
    const {lower, upper} = rangeAround(core, miles);
    return {core, lower, upper};
  }

  /* ===== Enforce R1 ≤ R2 ≤ R3 ===== */
  function orderGuard(r1, r2, r3, miles){
    if(r2.core < r1.core) r2.core = r1.core;
    if(r3.core < r2.core) r3.core = r2.core;
    Object.assign(r1, rangeAround(r1.core, miles));
    Object.assign(r2, rangeAround(r2.core, miles));
    Object.assign(r3, rangeAround(r3.core, miles));
    return {r1,r2,r3};
  }

  /* ===== UI ===== */
  function £fmt(core, lo, hi){ const f=n=>'£'+(Math.round(n*100)/100).toFixed(2); return `${f(core)}  (${f(lo)}–${f(hi)})`; }

  function refresh(now=new Date()){
    updateComputedFields();
    const mins  = Number(document.getElementById('mins').value);
    const miles = Number(document.getElementById('miles').value);
    if(Number.isNaN(mins) || Number.isNaN(miles)){
      document.getElementById('r1').textContent='–';
      document.getElementById('r2').textContent='–';
      document.getElementById('r3').textContent='–';
      document.getElementById('activeRatePill').textContent = 'Active: '+activeRateName(now);
      return;
    }
    let r1 = estimate('rate1', mins, miles);
    let r2 = estimate('rate2', mins, miles);
    let r3 = estimate('rate3', mins, miles);
    ({r1,r2,r3} = orderGuard(r1, r2, r3, miles));
    document.getElementById('r1').textContent = £fmt(r1.core, r1.lower, r1.upper);
    document.getElementById('r2').textContent = £fmt(r2.core, r2.lower, r2.upper);
    document.getElementById('r3').textContent = £fmt(r3.core, r3.lower, r3.upper);
    const act = activeRateName(now);
    document.getElementById('activeRatePill').textContent = 'Active: '+act;
    return {mins, miles, r1, r2, r3, act};
  }

  /* ===== Storage: IndexedDB + localStorage mirror ===== */
  const DB_NAME='cabwizz_db', DB_STORE='logs', DB_VER=1, KEY='cabwizz_log_v1';
  function idbOpen(){
    return new Promise((res,rej)=>{
      const r=indexedDB.open(DB_NAME, DB_VER);
      r.onupgradeneeded=()=>{ r.result.createObjectStore(DB_STORE); };
      r.onsuccess=()=>res(r.result);
      r.onerror =()=>rej(r.error);
    });
  }
  function idbGet(key){
    return idbOpen().then(db=>new Promise((res,rej)=>{
      const tx=db.transaction(DB_STORE,'readonly').objectStore(DB_STORE).get(key);
      tx.onsuccess=()=>res(tx.result); tx.onerror=()=>rej(tx.error);
    }));
  }
  function idbSet(key,val){
    return idbOpen().then(db=>new Promise((res,rej)=>{
      const tx=db.transaction(DB_STORE,'readwrite').objectStore(DB_STORE).put(val,key);
      tx.onsuccess=()=>res(); tx.onerror=()=>rej(tx.error);
    }));
  }
  async function loadLog(){
    try{
      const ls = localStorage.getItem(KEY);
      if(ls) return JSON.parse(ls);
      const idb = await idbGet(KEY);
      return idb ? JSON.parse(idb) : [];
    }catch(e){ return []; }
  }
  async function saveLog(rows){
    const json = JSON.stringify(rows);
    localStorage.setItem(KEY, json);
    try{ await idbSet(KEY, json); }catch(e){}
    renderLog();
  }

  /* ===== Log + CSV ===== */
  function stampParts(d=new Date()){
    const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const p=n=>String(n).padStart(2,'0');
    return { day:days[d.getDay()], date:`${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`, time:`${p(d.getHours())}:${p(d.getMinutes())}` };
  }
  async function renderLog(){
    const body=document.getElementById('logBody'); body.innerHTML='';
    const rows=await loadLog();
    const cur=n=>n===''?'':'£'+Number(n).toFixed(2);
    rows.forEach((r,i)=>{
      const tr=document.createElement('tr');
      const when = `${r.day.slice(0,3)} ${r.date} ${r.time}`;
      tr.innerHTML=`<td>${i+1}</td>
        <td class="mono">${when}</td>
        <td>${r.startTime||''}</td>
        <td>${r.endTime||''}</td>
        <td>${r.startOdo??''}</td>
        <td>${r.endOdo??''}</td>
        <td>${r.mins}</td>
        <td>${r.miles}</td>
        <td>${r.active}</td>
        <td class="mono">${cur(r.r1c)} (${cur(r.r1l)}–${cur(r.r1u)})</td>
        <td class="mono">${cur(r.r2c)} (${cur(r.r2l)}–${cur(r.r2u)})</td>
        <td class="mono">${cur(r.r3c)} (${cur(r.r3l)}–${cur(r.r3u)})</td>
        <td>${cur(r.meter)}</td>`;
      body.appendChild(tr);
    });
  }
  async function exportCSV(){
    const rows=await loadLog();
    const head=['Day','Date','Time','StartTime','EndTime','StartOdo','EndOdo','Minutes','Miles','ActiveRate','R1 core','R1 lower','R1 upper','R2 core','R2 lower','R2 upper','R3 core','R3 lower','R3 upper','Meter'];
    const cur=n=>n===''?'':`£${Number(n).toFixed(2)}`;
    const csv=[head, ...rows.map(r=>[
      r.day,r.date,r.time,r.startTime||'',r.endTime||'',r.startOdo??'',r.endOdo??'',r.mins,r.miles,r.active,
      cur(r.r1c),cur(r.r1l),cur(r.r1u),
      cur(r.r2c),cur(r.r2l),cur(r.r2u),
      cur(r.r3c),cur(r.r3l),cur(r.r3u),
      cur(r.meter)
    ])].map(a=>a.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\r\n');
    const blob=new Blob(['\uFEFF',csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cabwizz_journeys.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  // ===== Attach events (now safe) =====
  const byId = id => document.getElementById(id);
  ['startTime','endTime','startOdo','endOdo'].forEach(id=>{
    const el = byId(id); if(el) el.addEventListener('input', ()=>refresh());
  });

  const calcBtn  = byId('calcBtn');
  const saveBtn  = byId('saveBtn');
  const clearBtn = byId('clearBtn');
  const exportBtn= byId('exportBtn');
  const resetBtn = byId('resetFieldsBtn');

  if(calcBtn)  calcBtn.addEventListener('click', ()=>{ const r=refresh(); if(!r) alert('Enter start/end times and odometer values first'); });
  if(saveBtn)  saveBtn.addEventListener('click', async ()=>{
    const res=refresh(); if(!res) return;
    const mins = Number(byId('mins').value), miles = Number(byId('miles').value);
    if(Number.isNaN(mins) || Number.isNaN(miles)){ alert('Please enter valid start/end times and odometer values.'); return; }
    const parts=stampParts();
    const row={
      day:parts.day,date:parts.date,time:parts.time,
      startTime:byId('startTime').value||'',
      endTime:byId('endTime').value||'',
      startOdo:byId('startOdo').value||'',
      endOdo:byId('endOdo').value||'',
      mins:res.mins,miles:res.miles, active:res.act,
      r1c:res.r1.core,r1l:res.r1.lower,r1u:res.r1.upper,
      r2c:res.r2.core,r2l:res.r2.lower,r2u:res.r2.upper,
      r3c:res.r3.core,r3l:res.r3.lower,r3u:res.r3.upper,
      meter:byId('meter').value?Number(byId('meter').value):''
    };
    const rows=await loadLog(); rows.push(row); await saveLog(rows);
    byId('meter').value='';
  });
  if(clearBtn) clearBtn.addEventListener('click', async ()=>{ if(confirm('Clear ALL saved journeys?')) await saveLog([]); });
  if(exportBtn) exportBtn.addEventListener('click', exportCSV);
  if(resetBtn) resetBtn.addEventListener('click', ()=>{
    ['startTime','endTime','startOdo','endOdo','mins','miles','meter'].forEach(id=>{ const el=byId(id); if(el) el.value=''; });
    const r1=byId('r1'), r2=byId('r2'), r3=byId('r3');
    if(r1) r1.textContent='–'; if(r2) r2.textContent='–'; if(r3) r3.textContent='–';
  });

  // First render
  renderLog();
  const pill=document.getElementById('activeRatePill');
  if(pill) pill.textContent = 'Active: '+activeRateName();
});
</script>
</body>
</html>
