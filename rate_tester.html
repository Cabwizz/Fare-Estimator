!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CabWizz RateTester — Simple Model (R1/R2/R3)</title>
<style>
  :root{--ok:#0a7;--warn:#f8a100;--danger:#d33;--ink:#111;--muted:#666;--stroke:#e6e6ea}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fafafb;color:var(--ink);margin:16px}
  h1{font-size:20px;margin:0 0 10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .card{background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:14px;margin:10px 0}
  label{display:block;font-size:13px;color:#333;margin:6px 0}
  input,select,textarea,button{font-size:14px;padding:10px;border:1px solid var(--stroke);border-radius:10px;background:#fff}
  textarea{width:100%;min-height:120px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  button{font-weight:600}
  .ok{background:var(--ok);color:#fff;border:none}
  .warn{background:var(--warn);color:#000;border:none}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #f0f0f3;padding:8px;text-align:left;vertical-align:top}
  th{background:#f7f7fb;position:sticky;top:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .over{background:rgba(211,51,51,.08)}
  .under{background:rgba(24,105,255,.08)}
  .good{background:rgba(10,167,112,.08)}
  .badge{background:#eef7f3;color:#045a36;font-size:11px;padding:2px 8px;border-radius:999px}
</style>
</head>
<body>

<h1>CabWizz RateTester <span class="badge">Simple Model (R1/R2/R3)</span></h1>

<div class="card">
  <div class="row">
    <div>
      <label>Choose Rate</label>
      <select id="rateSel">
        <option value="r1">Rate 1</option>
        <option value="r2">Rate 2</option>
        <option value="r3">Rate 3</option>
      </select>
    </div>
    <div>
      <label>Error threshold to flag (≥)</label>
      <input id="errThresh" type="number" step="0.1" value="1.50">
    </div>
  </div>

  <div class="row">
    <div>
      <label>Paste rows (either with header or not):<br><span class="muted">Format: minutes,miles,meter</span></label>
      <textarea id="pasteBox" placeholder="e.g.
10,1.4,14.20
26,4.9,38.80
..."></textarea>
      <div class="btns">
        <button class="ok" id="addPasted">Add pasted rows</button>
        <button class="warn" id="clearRows">Clear rows</button>
      </div>
    </div>
    <div>
      <label>Quick add single row</label>
      <div class="row">
        <input id="qMin" type="number" step="1" placeholder="minutes">
        <input id="qMi"  type="number" step="0.1" placeholder="miles">
      </div>
      <input id="qMeter" type="number" step="0.01" placeholder="meter fare (optional)" style="margin-top:8px">
      <div class="btns">
        <button id="addOne">Add row</button>
        <button id="runCalc">Calculate</button>
        <button id="exportCSV">Export CSV</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Filter</label>
          <select id="filterSel">
            <option value="all">All rows</option>
            <option value="problems">Problems (≥ threshold)</option>
            <option value="over">Over only</option>
            <option value="under">Under only</option>
            <option value="good">Within range</option>
          </select>
        </div>
        <div>
          <label>Show mins/mi ≥</label>
          <input id="mpmFlag" type="number" step="0.1" value="6.5">
        </div>
      </div>
      <div class="muted" style="margin-top:6px">
        Tip: change Rate or threshold and press <b>Calculate</b>.
      </div>
    </div>
  </div>
</div>

<div class="card" style="max-height:60vh;overflow:auto">
  <table id="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th>Minutes</th>
        <th>Miles</th>
        <th>Meter</th>
        <th>Core</th>
        <th>Lower</th>
        <th>Upper</th>
        <th>Error</th>
        <th>mins/mi</th>
        <th>Flag</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ========= Simple unified model ========= */

const BASE_FARE = 4.20;
const INC = 0.20;

const RATES = {
  r1:{t0:0.30,tSlope:0.08,d0:3.40,dSlope:0.60,congK:0.18,congH:6.5,longTaper10:0.85,longTaper15:0.75},
  r2:{t0:0.33,tSlope:0.12,d0:3.60,dSlope:0.70,congK:0.22,congH:6.2,longTaper10:0.86,longTaper15:0.76},
  r3:{t0:0.40,tSlope:0.20,d0:3.80,dSlope:0.80,congK:0.26,congH:5.8,longTaper10:0.88,longTaper15:0.78}
};

const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const roundTo=(x,inc)=>Math.round(x/inc)*inc;

function timeRate(P, miles){
  const grow = clamp(miles/7,0,1);
  let r = P.t0 + P.tSlope*grow;
  if(miles>15) r*=P.longTaper15;
  else if(miles>10) r*=P.longTaper10;
  return r;
}
function distRate(P, mins){
  const grow = clamp(mins/30,0,1);
  return P.d0 + P.dSlope*grow;
}
function congestionUplift(P, mins, miles){
  const mpm = mins/Math.max(miles,0.3);
  const over = Math.max(0, mpm - P.congH);
  return P.congK * over * miles;
}
function tolerance(core){
  if(core<=20) return 1.00;
  if(core<=40) return 1.20;
  if(core<=60) return 1.40;
  return 1.60;
}
function estimateSimple(rateKey, mins, miles){
  const P = RATES[rateKey];
  const tPart = timeRate(P,miles)*mins;
  const dPart = distRate(P,mins)*miles;
  const cPart = congestionUplift(P,mins,miles);
  let core = BASE_FARE + tPart + dPart + cPart;
  core = roundTo(core, INC);
  const tol = tolerance(core);
  const lower = roundTo(core - tol, INC);
  const upper = roundTo(core + tol, INC);
  return {core,lower,upper};
}

/* ========= Tester logic ========= */

const rows=[]; // {mins,miles,meter,core,lower,upper,error,mpm,flag}

const $=id=>document.getElementById(id);
function fmt(x){return x===''||x==null?'':Number(x).toFixed(2);}

function parsePasted(txt){
  const out=[];
  txt.split(/\r?\n/).forEach(line=>{
    const s=line.trim();
    if(!s) return;
    const parts=s.split(',').map(v=>v.trim());
    if(parts.length<2) return;
    // header guard
    if(/minute/i.test(parts[0]) || /mins?/i.test(parts[0])) return;
    const m = Number(parts[0]), mi = Number(parts[1]), meter = parts[2]!==undefined && parts[2]!=='' ? Number(parts[2]) : '';
    if(Number.isFinite(m) && Number.isFinite(mi)) out.push({mins:m, miles:mi, meter});
  });
  return out;
}

function calcAll(){
  const rateKey = $('rateSel').value;
  const thresh = Number($('errThresh').value)||1.5;
  const mpmCut = Number($('mpmFlag').value)||6.5;

  rows.forEach(r=>{
    const est = estimateSimple(rateKey, r.mins, r.miles);
    r.core = est.core; r.lower = est.lower; r.upper = est.upper;
    r.error = (r.meter===''? '' : Number((r.meter - r.core).toFixed(2)));
    r.mpm = Number((r.mins/Math.max(r.miles,0.3)).toFixed(2));

    // flagging
    let f='';
    if(r.meter!==''){
      if (Math.abs(r.error) >= thresh){
        f = r.error>0 ? 'over' : 'under';
      } else {
        f = 'good';
      }
    }
    if(r.mpm >= mpmCut){
      f = (f? f+',' : '') + 'slow';
    }
    r.flag = f;
  });

  render();
}

function render(){
  const tbody=$('tbody'); tbody.innerHTML='';
  const filter=$('filterSel').value;
  const rateKey=$('rateSel').value;

  rows.forEach((r,i)=>{
    // filter
    const isProb = (r.flag||'').includes('over') || (r.flag||'').includes('under');
    if(filter==='problems' && !isProb) return;
    if(filter==='over' && !(r.flag||'').includes('over')) return;
    if(filter==='under' && !(r.flag||'').includes('under')) return;
    if(filter==='good' && (r.flag||'').includes('over') || (r.flag||'').includes('under')) return;

    const tr=document.createElement('tr');
    let cls='';
    if((r.flag||'').includes('over')) cls='over';
    else if((r.flag||'').includes('under')) cls='under';
    else if((r.flag||'').includes('good')) cls='good';
    tr.className=cls;

    tr.innerHTML=`
      <td class="mono">${i+1}</td>
      <td>${r.mins}</td>
      <td>${r.miles}</td>
      <td class="mono">${r.meter===''?'':('£'+fmt(r.meter))}</td>
      <td class="mono">£${fmt(r.core)}</td>
      <td class="mono">£${fmt(r.lower)}</td>
      <td class="mono">£${fmt(r.upper)}</td>
      <td class="mono">${r.meter===''?'':(r.error>0?'+':'')}${r.meter===''?'':fmt(r.error)}</td>
      <td class="mono">${fmt(r.mpm)}</td>
      <td>${r.flag||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

$('addPasted').addEventListener('click', ()=>{
  const arr = parsePasted($('pasteBox').value);
  arr.forEach(x=>rows.push(x));
  $('pasteBox').value='';
  calcAll();
});
$('clearRows').addEventListener('click', ()=>{
  if(confirm('Clear all rows?')){ rows.length=0; render(); }
});
$('addOne').addEventListener('click', ()=>{
  const m=Number($('qMin').value), mi=Number($('qMi').value);
  if(!Number.isFinite(m)||!Number.isFinite(mi)) return alert('Enter minutes and miles.');
  const meter=$('qMeter').value===''?'':Number($('qMeter').value);
  rows.push({mins:m,miles:mi,meter});
  $('qMin').value=''; $('qMi').value=''; $('qMeter').value='';
  calcAll();
});
$('runCalc').addEventListener('click', calcAll);
$('filterSel').addEventListener('change', render);
$('rateSel').addEventListener('change', calcAll);
$('errThresh').addEventListener('input', calcAll);
$('mpmFlag').addEventListener('input', calcAll);

$('exportCSV').addEventListener('click', ()=>{
  const head=['minutes','miles','meter','core','lower','upper','error','mins_per_mile','flags'];
  const lines=[head.join(',')];
  rows.forEach(r=>{
    lines.push([r.mins,r.miles,(r.meter===''?'':r.meter),r.core,r.lower,r.upper,(r.meter===''?'':r.error),r.mpm,(r.flag||'')].join(','));
  });
  const blob=new Blob([lines.join('\r\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='cabwizz_ratetest_results.csv'; a.click(); URL.revokeObjectURL(a.href);
});

// seed example
rows.push({mins:20,miles:4.9,meter:35.40},{mins:26,miles:4.9,meter:38.80});
calcAll();
</script>
</body>
</html>
