<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CabWizz Rate Tester (R1 / R2 / R3)</title>
<style>
  :root{--stroke:#d1d1d6;--bg:#f7f7f8}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:16px;color:#111}
  h1{font-size:18px;margin:0 0 10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:700px){.row{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:10px 0}
  label{font-size:13px;color:#333;margin:6px 0;display:block}
  input,select,button,textarea{font-size:14px;border:1px solid var(--stroke);border-radius:12px;padding:10px;background:#fff;width:100%}
  textarea{min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  .btn{cursor:pointer}
  .ok{background:#0a7;color:#fff;border:none}
  .warn{background:#f8a100;color:#fff;border:none}
  .muted{color:#666}
</style>
</head>
<body>
<h1>CabWizz Rate Tester (R1 / R2 / R3)</h1>

<div class="card">
  <div class="row">
    <div>
      <label>Active rate for this run</label>
      <select id="activeRate">
        <option value="rate1">Rate 1</option>
        <option value="rate2">Rate 2</option>
        <option value="rate3">Rate 3</option>
      </select>
      <label style="margin-top:8px">
        <input type="checkbox" id="usePerRowRate" style="width:auto;margin-right:6px"> Use per-row rate (column “rate”)
      </label>
    </div>
    <div>
      <label>Quick paste (CSV)</label>
      <textarea id="pasteBox" placeholder="Paste rows here. Header allowed.
Either:
minutes,miles,meter
14,1.9,16.20
…
or (per-row rate):
rate,minutes,miles,meter
1,14,1.9,16.20
3,25,3.4,32.00"></textarea>
    </div>
  </div>
  <div class="btns" style="margin-top:10px">
    <button class="btn ok" id="addRowsBtn">Add pasted rows</button>
    <button class="btn" id="addEmptyBtn">Add empty row</button>
    <button class="btn warn" id="calcBtn">Calculate</button>
    <button class="btn" id="exportBtn">Export CSV</button>
    <button class="btn" id="clearBtn">Clear table</button>
  </div>
  <div class="muted" style="margin-top:6px">Tip: You can mix rows from different rates — tick “Use per-row rate”.</div>
</div>

<div class="card" style="max-height:60vh;overflow:auto">
  <table id="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th>Rate</th>
        <th>Minutes</th>
        <th>Miles</th>
        <th>Meter (£)</th>
        <th>Core (£)</th>
        <th>Lower (£)</th>
        <th>Upper (£)</th>
        <th>Error (core−meter)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ====== SAME ENGINE AS YOUR ESTIMATOR ====== */
const cfg = {
  baseFare: 4.20,
  inc: 0.20,
  rangeBands: [
    { max: 1.5, lower:{fixed:0.30,pct:0.02}, upper:{fixed:0.60,pct:0.05} },
    { max: 2.5, lower:{fixed:0.60,pct:0.04}, upper:{fixed:1.00,pct:0.06} },
    { max: 4.5, lower:{fixed:1.00,pct:0.04}, upper:{fixed:1.60,pct:0.06} },
    { max: 6.5, lower:{fixed:1.60,pct:0.04}, upper:{fixed:2.00,pct:0.05} },
    { max: 1e9, lower:{fixed:2.00,pct:0.02}, upper:{fixed:2.50,pct:0.04} },
  ],

  /* ---- Rate 1 (from your running estimator) ---- */
  rate1:{
    perMinute:[{upTo:12,v:0.30},{upTo:25,v:0.36},{v:0.40}],
    perMileRules:[
      {when:{mMin:4.0,mMax:4.8,tMin:31,tMax:45}, v:4.30},
      {when:{mMin:4.0,mMax:4.8,tMin:16,tMax:30}, v:3.85},
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:3.65},
      {when:{mMin:25}, v:3.80},
      {when:{mMin:15}, v:3.95},
      {when:{mMin:7},  v:4.05},
      {when:{mMax:6.0}, v:3.60},
      {v:4.29}
    ],
    offsets:[
      {when:{mMin:3.0,mMax:5.0,tMin:18,tMax:40}, d:1.20}
    ],
    longTrim:{ enabled:true, when:{mMin:35,tMin:90}, pct:0.03, minAbs:2.00 }
  },

  /* ---- Rate 2 (your current profile) ---- */
  rate2:{
    perMinute:[{upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60}],
    perMileRules:[
      {when:{mMin:4.1,mMax:4.6,tMin:16,tMax:19}, v:4.75},
      {when:{mMin:3.90,mMax:4.05,tMin:20,tMax:22}, v:4.55},
      {when:{mMin:3.80,mMax:4.10,tMin:23,tMax:26}, v:4.70},
      {when:{mMin:4.20,mMax:4.50,tMin:20,tMax:26}, v:5.35},
      {when:{mMin:4.20,mMax:4.50,tMin:27,tMax:40}, v:5.15},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, v:3.85},
      {when:{mMin:18,mMax:25,tMin:55,tMax:70},  v:4.08},
      {when:{mMin:25}, v:4.12},
      {when:{mMin:7.5}, v:4.15},
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:4.00},
      {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, v:3.65},
      {v:4.29}
    ],
    offsets:[
      {when:{mMax:1.0}, d:0.00},
      {when:{mMin:1.5,mMax:2.8,tMin:12,tMax:20}, d:1.60},
      {when:{mMax:1.2,tMin:6,tMax:13}, d:0.40},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, d:-1.20},
      {when:{mMin:18,mMax:21,tMin:45,tMax:60}, d:-1.20}
    ],
    longTrim:{ enabled:true, when:{mMin:25,tMin:65}, pct:0.05, minAbs:3.50 }
  },

  /* ---- Rate 3 (R3 tuned — same as your v3.3 tester) ---- */
  rate3:{
    perMinute:[{upTo:12,v:0.58},{upTo:30,v:0.62},{v:0.44}],
    perMileRules:[
      { when:{ mMin:3.3,mMax:3.6,tMin:14,tMax:22 }, v:3.55 },
      { when:{ mMin:3.3,mMax:3.6,tMin:23,tMax:28 }, v:3.60 },
      { when:{ mMin:4.5,mMax:5.0,tMin:16,tMax:22 }, v:3.70 },
      { when:{ mMin:4.5,mMax:5.0,tMin:23,tMax:32 }, v:3.55 },
      { when:{ mMin:5.0,mMax:6.0,tMin:18,tMax:24 }, v:3.45 },
      { when:{ mMin:5.0,mMax:6.0,tMin:25,tMax:34 }, v:3.38 },
      { when:{ mMin:6.0,mMax:6.6,tMin:22,tMax:32 }, v:3.35 },
      { when:{ mMin:7.5,mMax:9.5,tMin:26,tMax:36 }, v:3.25 },
      { when:{ mMin:7.5,mMax:9.5,tMin:37,tMax:46 }, v:3.10 },
      { v:4.00 }
    ],
    offsets:[
      {when:{mMax:0.5,tMax:5}, d:-0.60},
      {when:{mMax:0.8,tMax:5}, d:-0.40},
      {when:{mMin:1.8,mMax:2.2,tMin:9,tMax:12}, d:-1.20},
      {when:{mMin:5.5,mMax:6.3,tMin:28,tMax:40}, d:-1.40},
      {when:{mMin:18,mMax:20,tMin:45,tMax:60}, d:1.20},
      {when:{mMin:4.0,mMax:5.6,tMin:15,tMax:35}, d:-0.80},
      {when:{mMin:6.5,mMax:8.0,tMin:22,tMax:40}, d:-1.00}
    ]
  }
};

/* ====== engine functions ====== */
const r2=(x)=>Math.round(x*100)/100;
const roundTo=(x,inc)=>Math.round(x/inc)*inc;
const floorTo=(x,inc)=>Math.floor(x/inc)*inc;
const ceilTo=(x,inc)=>Math.ceil(x/inc)*inc;

function matches(w, miles, mins){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  if(w.tMin!==undefined && mins  < w.tMin) return false;
  if(w.tMax!==undefined && mins  > w.tMax) return false;
  return true;
}
function pickPerMile(rules, miles, mins){
  const r = rules.find(x=>matches(x.when,miles,mins));
  return (r||rules[rules.length-1]).v;
}
function minutePart(tiers, mins){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    if(t.upTo==null){ sum+=rem*t.v; break; }
    const span=Math.max(0, Math.min(rem, t.upTo-used));
    sum += span*t.v; rem-=span; used+=span;
    if(rem<=0) break;
  }
  return sum;
}
function sumOffsets(arr, miles, mins){
  return (arr||[]).reduce((s,o)=>s+(matches(o.when,miles,mins)?o.d:0),0);
}
function baseBand(miles){
  return cfg.rangeBands.find(x=>miles<=x.max) || cfg.rangeBands[cfg.rangeBands.length-1];
}
function clampByFareSize(core, lower, upper){
  if(core <= 20){ lower = Math.min(lower, core - 1.00); upper = Math.max(upper, core + 1.00); }
  else if(core <= 40){ lower = Math.min(lower, core - 1.20); upper = Math.max(upper, core + 1.20); }
  else if(core <= 60){ lower = Math.min(lower, core - 1.40); upper = Math.max(upper, core + 1.40); }
  else { lower = Math.min(lower, core - 1.60); upper = Math.max(upper, core + 1.60); }
  return {lower, upper};
}
function buildRange(core, miles, mins){
  const b = baseBand(miles);
  let lowerAdj = Math.max(b.lower.fixed, core*b.lower.pct);
  let upperAdj = Math.max(b.upper.fixed, core*b.upper.pct);
  if(miles<=1.0){ lowerAdj = Math.min(lowerAdj, 1.00); upperAdj = Math.min(Math.max(upperAdj, 1.20), 1.80); }
  if(miles<=2.5 && mins>=15){ lowerAdj = Math.max(lowerAdj*1.05, lowerAdj+0.30); upperAdj = Math.max(upperAdj*1.20, upperAdj+0.80); }
  if(miles>=6 && mins>=35){ upperAdj = Math.max(upperAdj*1.12, upperAdj+0.80); }
  let lower = floorTo(roundTo(core - lowerAdj, cfg.inc), cfg.inc);
  let upper = ceilTo(roundTo(core + upperAdj, cfg.inc), cfg.inc);
  const c = clampByFareSize(core, lower, upper); lower=c.lower; upper=c.upper;
  if(miles<=0.8){ const absFloor=6.20; if(lower<absFloor) lower=roundTo(absFloor,cfg.inc); }
  return {lower,upper};
}
function estimate(rateKey, mins, miles){
  const r = cfg[rateKey];
  const mPart = minutePart(r.perMinute, mins);
  const perMile = pickPerMile(r.perMileRules, miles, mins);
  let core = cfg.baseFare + mPart + perMile*miles + sumOffsets(r.offsets, miles, mins);
  if(rateKey==='rate3' && miles>=3 && miles<=7 && mins>30){
    const k = 0.20 + 0.015*miles;
    core += roundTo(k*(mins-30), cfg.inc);
  }
  if(r.longTrim && matches(r.longTrim.when, miles, mins)){
    const rounded = roundTo(core, cfg.inc);
    const dec = Math.max(r.longTrim.minAbs, roundTo(rounded*r.longTrim.pct, cfg.inc));
    core = roundTo(rounded - dec, cfg.inc);
  }
  core = roundTo(core, cfg.inc);
  const {lower,upper} = buildRange(core, miles, mins);
  return {core,lower,upper};
}

/* ====== UI logic ====== */
const $ = (id)=>document.getElementById(id);
const tbody = $('tbody');

function addRow(obj={rate:'', minutes:'', miles:'', meter:''}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td></td>
    <td><input value="${obj.rate??''}" placeholder="1/2/3" style="width:60px"></td>
    <td><input value="${obj.minutes??''}" placeholder="min"></td>
    <td><input value="${obj.miles??''}" placeholder="mi"></td>
    <td><input value="${obj.meter??''}" placeholder="meter"></td>
    <td class="mono core"></td>
    <td class="mono lo"></td>
    <td class="mono hi"></td>
    <td class="mono err"></td>`;
  tbody.appendChild(tr);
  renumber();
}
function renumber(){
  [...tbody.querySelectorAll('tr')].forEach((tr,i)=>{
    tr.firstElementChild.textContent = i+1;
  });
}
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const head = lines[0].toLowerCase().split(',').map(s=>s.trim());
  const hasRate = head.includes('rate');
  const idx = {
    rate: head.indexOf('rate'),
    minutes: head.indexOf('minutes'),
    miles: head.indexOf('miles'),
    meter: head.indexOf('meter')
  };
  const rows = [];
  for(let i= (head.includes('minutes')&&head.includes('miles')) ? 1 : 0; i<lines.length; i++){
    const a = lines[i].split(',').map(s=>s.trim());
    rows.push({
      rate: hasRate ? a[idx.rate] : '',
      minutes: a[idx.minutes],
      miles: a[idx.miles],
      meter: a[idx.meter]||''
    });
  }
  return rows;
}
function calc(){
  const usePer = $('usePerRowRate').checked;
  const active = $('activeRate').value; // rate1/rate2/rate3
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const v = (sel)=>tr.querySelector(sel);
    const rateVal = v('td:nth-child(2) input').value.trim();
    const minutes = Number(v('td:nth-child(3) input').value);
    const miles   = Number(v('td:nth-child(4) input').value);
    const meter   = Number(v('td:nth-child(5) input').value);
    if(!Number.isFinite(minutes) || !Number.isFinite(miles)){
      v('.core').textContent=''; v('.lo').textContent=''; v('.hi').textContent=''; v('.err').textContent='';
      return;
    }
    const rateKey = usePer ? ({'1':'rate1','2':'rate2','3':'rate3'}[rateVal]||active) : active;
    const {core,lower,upper} = estimate(rateKey, minutes, miles);
    v('.core').textContent = '£'+core.toFixed(2);
    v('.lo').textContent   = '£'+lower.toFixed(2);
    v('.hi').textContent   = '£'+upper.toFixed(2);
    v('.err').textContent  = Number.isFinite(meter) ? (core - meter).toFixed(2) : '';
  });
}
function exportCSV(){
  const rows = [['rate','minutes','miles','meter','core','lower','upper','error']];
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const g=(n)=>tr.querySelector(`td:nth-child(${n}) input`)?.value||'';
    const core = tr.querySelector('.core')?.textContent.replace('£','')||'';
    const lo   = tr.querySelector('.lo')?.textContent.replace('£','')||'';
    const hi   = tr.querySelector('.hi')?.textContent.replace('£','')||'';
    const err  = tr.querySelector('.err')?.textContent||'';
    rows.push([g(2),g(3),g(4),g(5),core,lo,hi,err]);
  });
  const csv = rows.map(r=>r.map(s=>`"${String(s).replaceAll('"','""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='rate_test_results.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function clearTable(){ tbody.innerHTML=''; }

/* hooks */
$('addRowsBtn').onclick = ()=>{
  const rows = parseCSV($('pasteBox').value);
  rows.forEach(addRow);
  $('pasteBox').value='';
  renumber();
};
$('addEmptyBtn').onclick = ()=>{ addRow({}); };
$('calcBtn').onclick = calc;
$('exportBtn').onclick = exportCSV;
$('clearBtn').onclick = clearTable;

/* seed with one row */
addRow({rate:'1',minutes:'14',miles:'1.9',meter:'16.20'});
</script>
</body>
</html>

