<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CabWizz Fare Batch Tester</title>
<style>
  :root{--ok:#0a7;--warn:#f8a100;--danger:#d33;--stroke:#d1d1d6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f8;color:#111;margin:16px}
  h1{font-size:18px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .card{background:#fff;border:1px solid #e5e5ea;border-radius:14px;padding:14px}
  textarea{width:100%;min-height:160px;font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid var(--stroke);border-radius:12px;padding:10px}
  select,input,button{font-size:15px;padding:10px;border-radius:12px;border:1px solid var(--stroke);background:#fff}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .btn{border:none;color:#fff;background:var(--ok);font-weight:600;cursor:pointer}
  .btn.warn{background:var(--warn)} .btn.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
  th{background:#fafafa;position:sticky;top:0}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .in{background:#e8f7ee;color:#045a36} .out{background:#fdeaea;color:#8a1f11}
  .muted{color:#666}
</style>
</head>
<body>
<h1>CabWizz Fare Batch Tester</h1>

<div class="grid">
  <div class="card">
    <div class="row">
      <div>
        <label>Which rate to test?</label><br/>
        <select id="rateSel">
          <option value="rate1">Rate 1</option>
          <option value="rate2">Rate 2</option>
          <option value="rate3">Rate 3 (uses Rate 2 logic for 5+ mi)</option>
        </select>
      </div>
      <div>
        <label>Has header row?</label><br/>
        <select id="hasHeader">
          <option value="yes">Yes (minutes,miles[,meter])</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="row" style="align-items:end">
        <button class="btn" id="runBtn">Run Test</button>
        <button class="btn warn" id="exportBtn">Export Results CSV</button>
        <button class="btn danger" id="clearBtn">Clear</button>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">
      Paste rows as: <span class="mono">minutes,miles[,meter]</span> — meter is optional.
    </div>
    <textarea id="inp" placeholder="minutes,miles,meter&#10;12,1.7,14.20&#10;25,3.4,25.60&#10;38,9.1,58.20"></textarea>
  </div>

  <div class="card">
    <div id="summary" class="muted">No results yet.</div>
    <div style="max-height:60vh;overflow:auto;margin-top:10px">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th><th>Min</th><th>Mi</th>
            <th>Core</th><th>Range</th>
            <th>Meter</th><th>Δ (Core−Meter)</th><th>Within Range?</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* === same core config & estimator as the current app (v3.4) === */
const cfg = {
  baseFare: 4.20,
  inc: 0.20,
  rangeBands: [
    { max: 1.5, lower:{fixed:0.30,pct:0.02}, upper:{fixed:0.60,pct:0.05} },
    { max: 2.5, lower:{fixed:0.60,pct:0.04}, upper:{fixed:1.00,pct:0.06} },
    { max: 4.5, lower:{fixed:1.00,pct:0.04}, upper:{fixed:1.60,pct:0.06} },
    { max: 6.5, lower:{fixed:1.60,pct:0.04}, upper:{fixed:2.00,pct:0.05} },
    { max: 1e9, lower:{fixed:2.00,pct:0.02}, upper:{fixed:2.50,pct:0.04} },
  ],
  rate1:{
    perMinute:[{upTo:12,v:0.30},{upTo:25,v:0.36},{v:0.40}],
    perMileRules:[
      {when:{mMin:4.0,mMax:4.8,tMin:31,tMax:45}, v:4.30},
      {when:{mMin:4.0,mMax:4.8,tMin:16,tMax:30}, v:3.85},
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:3.65},
      {when:{mMin:25}, v:3.80},
      {when:{mMin:15}, v:3.95},
      {when:{mMin:7},  v:4.05},
      {when:{mMax:6.0}, v:3.60},
      {v:4.29}
    ],
    offsets:[
      {when:{mMin:3.0,mMax:5.0,tMin:18,tMax:40}, d:1.20}
    ],
    longTrim:{ enabled:true, when:{mMin:35,tMin:90}, pct:0.03, minAbs:2.00 }
  },
  rate2:{
    perMinute:[{upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60}],
    perMileRules:[
      {when:{mMin:4.1,mMax:4.6,tMin:16,tMax:19}, v:4.75},
      {when:{mMin:3.90,mMax:4.05,tMin:20,tMax:22}, v:4.55},
      {when:{mMin:3.80,mMax:4.10,tMin:23,tMax:26}, v:4.70},
      {when:{mMin:4.20,mMax:4.50,tMin:20,tMax:26}, v:5.35},
      {when:{mMin:4.20,mMax:4.50,tMin:27,tMax:40}, v:5.15},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, v:3.85},
      {when:{mMin:18,mMax:25,tMin:55,tMax:70},  v:4.08},
      {when:{mMin:25}, v:4.12},
      {when:{mMin:7.5}, v:4.15},
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:4.00},
      {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, v:3.65},
      {v:4.29}
    ],
    offsets:[
      {when:{mMax:1.0}, d:0.00},
      {when:{mMin:1.5,mMax:2.8,tMin:12,tMax:20}, d:1.60},
      {when:{mMax:1.2,tMin:6,tMax:13}, d:0.40},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, d:-1.20},
      {when:{mMin:18,mMax:21,tMin:45,tMax:60}, d:-1.20}
    ],
    longTrim:{ enabled:true, when:{mMin:25,tMin:65}, pct:0.05, minAbs:3.50 }
  },
  // Rate 3 (short-trip negative offsets removed) + “use R2 for 5+ mi” handled in estimator
  rate3:{
    perMinute:[
      { upTo: 12, v: 0.58 },
      { upTo: 30, v: 0.62 },
      { v: 0.44 }
    ],
    perMileRules:[
      { when: { mMin: 3.3, mMax: 3.6, tMin: 14, tMax: 22 }, v: 3.55 },
      { when: { mMin: 3.3, mMax: 3.6, tMin: 23, tMax: 28 }, v: 3.60 },
      { when: { mMin: 4.5, mMax: 5.0, tMin: 16, tMax: 22 }, v: 3.70 },
      { when: { mMin: 4.5, mMax: 5.0, tMin: 23, tMax: 32 }, v: 3.55 },
      { when: { mMin: 5.0, mMax: 6.0, tMin: 18, tMax: 24 }, v: 3.45 },
      { when: { mMin: 5.0, mMax: 6.0, tMin: 25, tMax: 34 }, v: 3.38 },
      { when: { mMin: 6.0, mMax: 6.6, tMin: 22, tMax: 32 }, v: 3.35 },
      { when: { mMin: 7.5, mMax: 9.5, tMin: 26, tMax: 36 }, v: 3.25 },
      { when: { mMin: 7.5, mMax: 9.5, tMin: 37, tMax: 46 }, v: 3.10 },
      { v: 4.00 }
    ],
    offsets:[
      {when:{mMin:1.8,mMax:2.2,tMin:9,tMax:12}, d:-1.20},
      {when:{mMin:5.5,mMax:6.3,tMin:28,tMax:40}, d:-1.40},
      {when:{mMin:18,mMax:20,tMin:45,tMax:60}, d:1.20},
      {when:{mMin:4.0,mMax:5.6,tMin:15,tMax:35}, d:-0.80},
      {when:{mMin:6.5,mMax:8.0,tMin:22,tMax:40}, d:-1.00}
    ]
  }
};

const r2=(x)=>Math.round(x*100)/100, roundTo=(x,i)=>Math.round(x/i)*i, floorTo=(x,i)=>Math.floor(x/i)*i, ceilTo=(x,i)=>Math.ceil(x/i)*i;

function matches(w, miles, mins){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  if(w.tMin!==undefined && mins  < w.tMin) return false;
  if(w.tMax!==undefined && mins  > w.tMax) return false;
  return true;
}
function pickPerMile(rules, miles, mins){
  const r = rules.find(x=>matches(x.when,miles,mins));
  return (r||rules[rules.length-1]).v;
}
function minutePart(tiers, mins){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    if(t.upTo==null){ sum+=rem*t.v; break; }
    const span=Math.max(0, Math.min(rem, t.upTo-used));
    sum += span*t.v; rem-=span; used+=span;
    if(rem<=0) break;
  }
  return sum;
}
function sumOffsets(arr, miles, mins){
  return arr.reduce((s,o)=>s+(matches(o.when,miles,mins)?o.d:0),0);
}

function baseBand(miles){
  return cfg.rangeBands.find(x=>miles<=x.max) || cfg.rangeBands[cfg.rangeBands.length-1];
}
function clampByFareSize(core, lower, upper){
  if(core <= 20){ lower = Math.min(lower, core - 1.00); upper = Math.max(upper, core + 1.00);
  } else if(core <= 40){ lower = Math.min(lower, core - 1.20); upper = Math.max(upper, core + 1.20);
  } else if(core <= 60){ lower = Math.min(lower, core - 1.40); upper = Math.max(upper, core + 1.40);
  } else { lower = Math.min(lower, core - 1.60); upper = Math.max(upper, core + 1.60); }
  return {lower, upper};
}
function buildRange(core, miles, mins){
  const b = baseBand(miles);
  let lowerAdj = Math.max(b.lower.fixed, core*b.lower.pct);
  let upperAdj = Math.max(b.upper.fixed, core*b.upper.pct);

  if(miles<=1.0){ lowerAdj = Math.min(lowerAdj, 1.00); upperAdj = Math.min(Math.max(upperAdj, 1.20), 1.80); }
  if(miles<=2.5 && mins>=15){ lowerAdj = Math.max(lowerAdj*1.05, lowerAdj+0.30); upperAdj = Math.max(upperAdj*1.20, upperAdj+0.80); }
  if(miles>=6 && mins>=35){ upperAdj = Math.max(upperAdj*1.12, upperAdj+0.80); }

  let lower = floorTo(roundTo(core - lowerAdj, cfg.inc), cfg.inc);
  let upper = ceilTo (roundTo(core + upperAdj, cfg.inc), cfg.inc);

  const c = clampByFareSize(core, lower, upper);
  lower = c.lower; upper = c.upper;

  if(miles<=0.8){ const abs = 6.20; if(lower < abs) lower = roundTo(abs, cfg.inc); }
  if(lower>upper){ const t=lower; lower=upper; upper=t; } // safety swap
  return {lower, upper};
}
function longTrim(core, trim, miles, mins){
  if(!trim||!trim.enabled) return core;
  if(!matches(trim.when,miles,mins)) return core;
  const rounded = roundTo(core, cfg.inc);
  const dec = Math.max(trim.minAbs, roundTo(rounded*trim.pct, cfg.inc));
  return roundTo(rounded - dec, cfg.inc);
}

function estimate(rateKey, mins, miles){
  const useR2ForR3 = (rateKey==='rate3' && miles>=5);
  const r = useR2ForR3 ? cfg.rate2 : cfg[rateKey];

  const mPart = minutePart(r.perMinute, mins);
  const perMile = pickPerMile(r.perMileRules, miles, mins);
  let core = cfg.baseFare + mPart + perMile*miles + sumOffsets(r.offsets||[], miles, mins);

  if(!useR2ForR3 && rateKey==='rate3' && miles>=3 && miles<=7 && mins>30){
    const k = 0.20 + 0.015*miles;
    const extra = roundTo(k * (mins - 30), cfg.inc);
    core += extra;
  }
  if(r.longTrim) core = longTrim(core, r.longTrim, miles, mins);
  core = roundTo(core, cfg.inc);

  const rng = buildRange(core, miles, mins);
  return { core, lower:rng.lower, upper:rng.upper };
}

/* === UI logic === */
const byId = id=>document.getElementById(id);
const tbody = byId('tbody');
const summary = byId('summary');

function parseCSV(text, hasHeader){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const start = hasHeader ? 1 : 0;
  const rows=[];
  for(let i=start;i<lines.length;i++){
    const parts = lines[i].split(',').map(s=>s.trim());
    if(parts.length<2) continue;
    const mins = Number(parts[0]), miles = Number(parts[1]);
    const meter = parts.length>=3 && parts[2]!=='' ? Number(parts[2]) : null;
    if(Number.isFinite(mins) && Number.isFinite(miles)) rows.push({mins,miles,meter});
  }
  return rows;
}

function fmt(x){ return '£'+r2(x).toFixed(2); }

let lastResults=[];

function run(){
  tbody.innerHTML='';
  lastResults=[];
  const rate = byId('rateSel').value;
  const rows = parseCSV(byId('inp').value, byId('hasHeader').value==='yes');
  if(!rows.length){ summary.textContent='No valid rows found.'; return; }

  let nMeter=0, sumAbs=0, sumSigned=0, within=0;

  rows.forEach((r,idx)=>{
    const est = estimate(rate, r.mins, r.miles);
    const meter = r.meter;
    let diff='', tag='';

    if(meter!=null && Number.isFinite(meter)){
      nMeter++;
      const d = r2(est.core - meter);
      diff = (d>=0?'+':'') + d.toFixed(2);
      sumAbs += Math.abs(d);
      sumSigned += d;
      if(meter>=est.lower && meter<=est.upper) within++;
      tag = `<span class="tag ${meter>=est.lower && meter<=est.upper?'in':'out'}">${meter>=est.lower && meter<=est.upper?'Within':'Outside'}</span>`;
    }

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${r.mins}</td>
      <td>${r.miles}</td>
      <td class="mono">${fmt(est.core)}</td>
      <td class="mono">${fmt(est.lower)}–${fmt(est.upper)}</td>
      <td class="mono">${meter!=null?fmt(meter):''}</td>
      <td class="mono">${diff}</td>
      <td>${meter!=null?tag:''}</td>
    `;
    tbody.appendChild(tr);

    lastResults.push({
      index: idx+1, minutes:r.mins, miles:r.miles,
      core: est.core, lower: est.lower, upper: est.upper,
      meter: meter, diff: meter!=null? r2(est.core - meter): ''
    });
  });

  let line = `${rows.length} rows processed on ${rate}.`;
  if(nMeter){
    const mae = r2(sumAbs/nMeter).toFixed(2);
    const bias = r2(sumSigned/nMeter).toFixed(2);
    const pctIn = Math.round((within/nMeter)*100);
    line += ` With meter: ${nMeter} rows • MAE £${mae} • Bias £${bias} • Within range ${pctIn}%.`;
  }
  summary.textContent = line;
}

function exportCSV(){
  if(!lastResults.length) return;
  const head = ["#", "minutes", "miles", "core", "lower", "upper", "meter", "diff"];
  const rows = [head.join(',')];
  lastResults.forEach(r=>{
    rows.push([r.index, r.minutes, r.miles, r.core.toFixed(2), r.lower.toFixed(2), r.upper.toFixed(2),
               r.meter!=null? r.meter.toFixed(2):"", r.diff!==''? r.diff.toFixed(2):""].join(','));
  });
  const blob = new Blob([rows.join('\r\n')], {type:'text/csv'});
  const a=document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cabwizz_batch_results.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

byId('runBtn').addEventListener('click', run);
byId('exportBtn').addEventListener('click', exportCSV);
byId('clearBtn').addEventListener('click', ()=>{
  byId('inp').value=''; tbody.innerHTML=''; summary.textContent='Cleared.';
  lastResults=[];
});
</script>
</body>
</html>
