<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CabWizz — RATE 1 Tester (Scalable vs R1 G–K)</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --bd:#e5e5ea;
    --blue:#1869ff; /* OVER */
    --red:#d23636;  /* UNDER */
    --near:#111;    /* within tolerance */
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:12px;color:#111}
  h1{font-size:18px;margin:0 0 10px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px;margin:10px 0}
  .grid{display:grid;gap:10px}
  .controls{grid-template-columns:repeat(6,minmax(0,1fr))}
  .inputs{grid-template-columns:1fr 1fr}
  @media (max-width:980px){.controls{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (max-width:560px){.controls{grid-template-columns:repeat(2,minmax(0,1fr))}.inputs{grid-template-columns:1fr}}
  label{font-size:12px;color:#444;display:block;margin-bottom:4px}
  input,select,button,textarea{width:100%;font-size:14px;border-radius:12px;border:1px solid var(--bd);padding:10px;background:#fff}
  textarea{min-height:110px}
  button{font-weight:600;cursor:pointer}
  .btn{background:#0a7;color:#fff;border:none}
  .btn.alt{background:#1869ff}
  .btn.gray{background:#fff;color:#111;border:1px solid var(--bd)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .over{color:var(--blue);font-weight:700}
  .under{color:var(--red);font-weight:700}
  .near{color:var(--near)}
  .tiny{color:#666;font-size:12px;margin-top:6px}
</style>
</head>
<body>
  <h1>CabWizz — RATE 1 Tester (Scalable vs R1 G–K)</h1>

  <!-- Simple admin controls kept compatible with fare rises -->
  <div class="card">
    <div class="grid controls">
      <div>
        <label>Base Fare (£)</label>
        <input id="baseFare" type="number" step="0.01" value="4.20">
      </div>
      <div>
        <label>Global uplift (%)</label>
        <input id="upliftGlobal" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Rate 1 uplift (%)</label>
        <input id="upliftR1" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Tariff-4 align (≥ mi)</label>
        <input id="t4Miles" type="number" step="0.1" value="6.0">
      </div>
      <div>
        <label>Tariff-4 alignment</label>
        <select id="t4Align">
          <option value="on" selected>On (use R2 per-mile ≥ threshold)</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div>
        <label>Rate-4 uplift (%) — per-mile only</label>
        <input id="upliftR4" type="number" step="0.01" value="0">
      </div>

      <div>
        <label>Tolerance (±£)</label>
        <input id="tol" type="number" step="0.1" value="0.60">
      </div>
      <div>
        <label>Sort by |Δ|</label>
        <select id="sortSel">
          <option value="none" selected>None</option>
          <option value="scal_asc">Scalable least → most</option>
          <option value="scal_desc">Scalable most → least</option>
          <option value="adj_asc">Adj least → most</option>
          <option value="adj_desc">Adj most → least</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="recalcBtn">Recalculate</button>
      </div>
    </div>
  </div>

  <!-- Paste minutes,miles,meter only -->
  <div class="card">
    <div class="grid inputs">
      <div>
        <label>Paste CSV (minutes,miles,meter) — one per line</label>
        <textarea id="pasteBox" placeholder="e.g. 29,6.3,35.80&#10;43,6.0,44.40&#10;38,6.0,41.20&#10;30,6.0,35.40"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="addPasted">Add pasted rows</button>
          <button class="btn gray" id="clearAll">Clear table</button>
          <button class="btn alt" id="exportBtn">Export CSV</button>
        </div>
        <div class="tiny">Over = blue (estimator &gt; meter). Under = red (estimator &lt; meter). |Δ| ≤ tolerance = black.</div>
      </div>
      <div>
        <label>Quick add (one row)</label>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
          <div><input id="qMin" type="number" step="1" placeholder="Minutes"></div>
          <div><input id="qMi" type="number" step="0.1" placeholder="Miles"></div>
          <div><input id="qMeter" type="number" step="0.01" placeholder="Meter £"></div>
        </div>
        <button class="btn" id="addOne" style="margin-top:8px">Add row</button>
        <p class="mono" style="margin-top:10px;color:#555">Change multipliers anytime — table recalculates instantly.</p>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="max-height:65vh;overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Min</th>
          <th>Mi</th>
          <th>Meter</th>
          <th>Core (Scalable)</th>
          <th>Δ vs Meter (Scal)</th>
          <th>Core (Scal + R1 G–K)</th>
          <th>Δ vs Meter (Adj)</th>
          <th>Adj − Scal</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const r2 = x => Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const clamp = (v,lo,hi)=>Math.max(lo, Math.min(hi, v));
const INC = 0.20;

/* ===== Per-minute tiers & per-mile rules (Rate 1 baseline) ===== */
const R1 = {
  perMinute:[ {upTo:6,v:0.29},{upTo:12,v:0.34},{upTo:25,v:0.38},{v:0.46} ],
  perMileRules:[ // piecewise per-mile for Rate 1
    {when:{mMax:2.0},v:3.60},
    {when:{mMin:2.0,mMax:3.5},v:3.75},
    {when:{mMin:3.5,mMax:4.8},v:3.90},
    {when:{mMin:4.8,mMax:7.0},v:4.00},
    {when:{mMin:7.0,mMax:15},v:4.08},
    {when:{mMin:15,mMax:25},v:3.95},
    {v:3.80}
  ]
};
// Rate 2 per-mile for Tariff-4 alignment use
const R2_mile = [
  {when:{mMax:1.0},v:3.60},
  {when:{mMin:1.0,mMax:2.2},v:3.75},
  {when:{mMin:2.2,mMax:3.5},v:3.95},
  {when:{mMin:3.5,mMax:4.6},v:4.15},
  {when:{mMin:4.6,mMax:7.5},v:4.35},
  {when:{mMin:7.5,mMax:10},v:4.05},
  {when:{mMin:10},v:4.10}
];

function minutePart(tiers, mins, mul){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    const up = t.upTo==null ? Infinity : t.upTo;
    const span = Math.max(0, Math.min(rem, up-used));
    sum += span * (t.v*mul);
    rem -= span; used += span; if(rem<=0) break;
  }
  return sum;
}
function pickPerMile(rules, miles){
  const r = rules.find(x=>{
    const w = x.when||{};
    if(w.mMin!==undefined && miles < w.mMin) return false;
    if(w.mMax!==undefined && miles > w.mMax) return false;
    return true;
  });
  return (r||rules[rules.length-1]).v;
}

/* ===== Admin getters ===== */
function getAdmin(){
  const baseFare = Number($('baseFare').value)||4.20;
  const g = (Number($('upliftGlobal').value)||0)/100 + 1;
  const r1 = (Number($('upliftR1').value)||0)/100 + 1;
  const r4 = (Number($('upliftR4').value)||0)/100 + 1;
  const t4Miles = Number($('t4Miles').value)||6.0;
  const t4Align = $('t4Align').value==='on';
  return {baseFare,g,r1,r4,t4Miles,t4Align};
}

/* ===== Scalable core (Rate 1) ===== */
function coreScalable_R1(mins, miles){
  const A = getAdmin();
  const mMul = A.g * A.r1;
  let pmRules = R1.perMileRules;
  let pmMul   = A.g * A.r1;

  if (A.t4Align && miles >= A.t4Miles){
    pmRules = R2_mile;
    pmMul   = A.g * A.r1 * A.r4; // R4 uplift applies to per-mile only
  }

  const mPart = minutePart(R1.perMinute, mins, mMul);
  const perMi = pickPerMile(pmRules, miles) * pmMul;
  const milePart = perMi * miles;

  let core = A.baseFare + mPart + milePart;
  return roundTo(core, INC);
}

/* ===== RATE 1 band corrections (G–K) — post-core additive, then round20p =====
   Bands (mi): G:4.0–4.9, H:5.0–5.9, I1:6.0–6.3, I2:6.4–6.9, J:7.0–7.9, K:8.0–8.9
   Formulas chosen to match your examples; clamped to avoid overshoot.
*/
function corr_R1_G(mins){ // 4.0–4.9
  return clamp( 0.90*(mins - 36), -0.60, +2.00 );
}
function corr_R1_H(mins){ // 5.0–5.9
  return clamp( 0.30*(mins - 44) + 0.10, -1.40, +2.80 );
}
function corr_R1_I1(mins){ // 6.0–6.3
  return clamp( -4.00 + 0.29*(mins - 30), -4.50, +3.00 );
}
function corr_R1_I2(mins){ // 6.4–6.9
  return clamp( -1.00 + 0.29*(mins - 30), -2.00, +3.00 );
}
function corr_R1_J(mins){ // 7.0–7.9
  return clamp( -4.20 + 0.53*(mins - 37), -5.00, +2.00 );
}
function corr_R1_K(mins){ // 8.0–8.9
  return clamp( 0.35*(mins - 45), -1.00, +2.00 );
}
function bandCorr_R1(mins, miles){
  if(miles>=4.0 && miles<5.0) return corr_R1_G(mins);
  if(miles>=5.0 && miles<6.0) return corr_R1_H(mins);
  if(miles>=6.0 && miles<6.4) return corr_R1_I1(mins);
  if(miles>=6.4 && miles<7.0) return corr_R1_I2(mins);
  if(miles>=7.0 && miles<8.0) return corr_R1_J(mins);
  if(miles>=8.0 && miles<9.0) return corr_R1_K(mins);
  return 0; // outside G–K, no change
}

/* ===== UI + table ===== */
let rows = []; // {mins, miles, meter}

function parseCSV(text){
  const out=[];
  text.split(/\r?\n/).forEach(line=>{
    const s=line.trim(); if(!s) return;
    const parts=s.split(',').map(x=>x.trim());
    if(parts.length<3) return;
    const mins = Number(parts[0]);
    const miles = Number(parts[1]);
    const meter = Number(String(parts[2]).replace('£',''));
    if(Number.isFinite(mins)&&Number.isFinite(miles)&&Number.isFinite(meter)) out.push({mins,miles,meter});
  });
  return out;
}
function classify(err, tol){ if(Math.abs(err)<=tol) return 'near'; return err>0?'over':'under'; }

function recalcAndRender(){
  const tol = Number($('tol').value)||0.60;
  const sort = $('sortSel').value;

  const computed = rows.map((r,i)=>{
    const coreScal = coreScalable_R1(r.mins, r.miles);
    const corr = bandCorr_R1(r.mins, r.miles);
    const coreAdj = roundTo(coreScal + corr, INC);
    const errS = r2(coreScal - r.meter);
    const errA = r2(coreAdj   - r.meter);
    return {idx:i+1, ...r, coreScal, coreAdj, errS, errA, delta:r2(coreAdj-coreScal)};
  });

  let view = computed;
  if(sort==='scal_asc')  view = [...view].sort((a,b)=>Math.abs(a.errS)-Math.abs(b.errS));
  if(sort==='scal_desc') view = [...view].sort((a,b)=>Math.abs(b.errS)-Math.abs(a.errS));
  if(sort==='adj_asc')   view = [...view].sort((a,b)=>Math.abs(a.errA)-Math.abs(b.errA));
  if(sort==='adj_desc')  view = [...view].sort((a,b)=>Math.abs(b.errA)-Math.abs(a.errA));

  const tb = $('tbody'); tb.innerHTML='';
  for(const r of view){
    const clsS = classify(r.errS, tol);
    const clsA = classify(r.errA, tol);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${r.idx}</td>
      <td>${r.mins}</td>
      <td>${r.miles.toFixed(1)}</td>
      <td class="mono">£${r.meter.toFixed(2)}</td>
      <td class="mono">£${r.coreScal.toFixed(2)}</td>
      <td class="mono ${clsS}">${r.errS>0?'+':''}${r.errS.toFixed(2)}</td>
      <td class="mono">£${r.coreAdj.toFixed(2)}</td>
      <td class="mono ${clsA}">${r.errA>0?'+':''}${r.errA.toFixed(2)}</td>
      <td class="mono">${r.delta>0?'+':''}${r.delta.toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  }
}

/* Buttons */
$('addPasted').addEventListener('click', ()=>{
  const arr = parseCSV($('pasteBox').value);
  rows = rows.concat(arr);
  $('pasteBox').value='';
  recalcAndRender();
});
$('addOne').addEventListener('click', ()=>{
  const mins = Number($('qMin').value);
  const miles = Number($('qMi').value);
  const meter = Number($('qMeter').value);
  if(Number.isFinite(mins)&&Number.isFinite(miles)&&Number.isFinite(meter)){
    rows.push({mins,miles,meter});
    $('qMin').value=$('qMi').value=$('qMeter').value='';
    recalcAndRender();
  }
});
['baseFare','upliftGlobal','upliftR1','upliftR4','t4Miles','t4Align','tol','sortSel']
.forEach(id=>$(id).addEventListener('input', recalcAndRender));

$('recalcBtn').addEventListener('click', recalcAndRender);
$('clearAll').addEventListener('click', ()=>{ rows=[]; recalcAndRender(); });

$('exportBtn').addEventListener('click', ()=>{
  const tol = Number($('tol').value)||0.60;
  const A = getAdmin();
  const th = ["minutes","miles","meter",
              "core_scalable","diff_scalable",
              "core_adj_R1_GK","diff_adj",
              "adj_minus_scalable",
              "baseFare","upliftGlobal","upliftR1","t4Align","t4Miles","upliftR4","tolerance"];
  const out = rows.map(r=>{
    const cs = coreScalable_R1(r.mins, r.miles);
    const ca = roundTo(cs + bandCorr_R1(r.mins, r.miles), INC);
    const es = r2(cs - r.meter), ea = r2(ca - r.meter);
    return [r.mins,r.miles,r.meter, cs,es, ca,ea, r2(ca-cs),
            A.baseFare, A.g, A.r1, (A.t4Align?'on':'off'), A.t4Miles, A.r4, tol];
  });
  const csv = [th.join(',')].concat(out.map(a=>a.join(','))).join('\r\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='cabwizz_rate1_tester_scal_vs_GK.csv'; a.click(); URL.revokeObjectURL(a.href);
});

/* init */
recalcAndRender();
</script>
</body>
</html>
