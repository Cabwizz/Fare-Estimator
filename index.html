<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a7">
<title>CabWizz Fare Estimator (v1.7)</title>
<style>
  :root{--ok:#0a7;--warn:#f8a100;--info:#1869ff;--danger:#d33;--stroke:#d1d1d6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:12px;line-height:1.25;background:#f7f7f8;color:#111}
  h1{font-size:18px;margin:0 0 8px}
  .version-badge{display:inline-block;font-size:11px;background:#eef;border:1px solid rgba(0,0,0,.05);padding:2px 6px;border-radius:999px;margin-left:6px;color:#1869ff}
  .card{border:1px solid #e5e5ea;border-radius:16px;padding:14px;margin:10px 0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  label{display:block;font-size:14px;margin:10px 0 6px;color:#333}
  input,button{font-size:16px;padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);width:100%;background:#fff}
  input::placeholder{color:#b0b0b5}
  .row{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media (max-width:420px){ .row,.row3{grid-template-columns:1fr} }
  .timeRow input[type="time"]{-webkit-appearance:none;appearance:none;text-align:center;font-variant-numeric:tabular-nums;line-height:1;min-height:48px}
  .timeRow .cell{display:flex;align-items:center}
  .timeRow .cell input{width:100%}
  .out{font-weight:700}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{color:#666}
  .btns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .btn{border:none;color:#fff;font-weight:600;text-align:center;border-radius:16px;padding:14px;width:100%;box-shadow:0 1px 0 rgba(0,0,0,.08), inset 0 -1px 0 rgba(0,0,0,.08)}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .info{background:var(--info)} .danger{background:var(--danger)}
  .btn.outline-danger{background:#fff;color:var(--danger);border:1px solid var(--danger);box-shadow:none}
  .btn.outline{background:#fff;color:#333;border:1px solid var(--stroke);box-shadow:none}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:0}
  .tiny{color:#888;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<h1>CabWizz Fare Estimator <span class="version-badge">v1.7</span></h1>

<div class="card">
  <!-- Times -->
  <div class="row timeRow">
    <div class="cell"><div style="width:100%">
      <label for="tStart">Start time</label>
      <input id="tStart" type="time" step="60" />
    </div></div>
    <div class="cell"><div style="width:100%">
      <label for="tEnd">End time</label>
      <input id="tEnd" type="time" step="60" />
    </div></div>
  </div>

  <!-- Mileages -->
  <div class="row">
    <div>
      <label for="miStart">Start mileage</label>
      <input id="miStart" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 12034.5" />
    </div>
    <div>
      <label for="miEnd">End mileage</label>
      <input id="miEnd" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 12040.1" />
    </div>
  </div>

  <!-- Calculated/Manual fields -->
  <div class="row" style="margin-top:6px">
    <div>
      <label for="mins">Minutes</label>
      <input id="mins" type="number" inputmode="numeric" step="1" min="0" placeholder="e.g. 17" />
    </div>
    <div>
      <label for="miles">Miles</label>
      <input id="miles" type="number" inputmode="decimal" step="0.1" min="0" placeholder="e.g. 2.8" />
    </div>
  </div>

  <!-- Meter -->
  <div style="margin-top:10px">
    <label for="meter">Actual meter fare (optional)</label>
    <input id="meter" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 17.40" />
  </div>

  <!-- Outputs -->
  <div class="row3" style="margin-top:12px">
    <div><div class="muted">Rate 1</div><div class="out mono" id="r1">–</div></div>
    <div><div class="muted">Rate 2</div><div class="out mono" id="r2">–</div></div>
    <div><div class="muted">Rate 3</div><div class="out mono" id="r3">–</div></div>
  </div>

  <!-- Buttons -->
  <div class="btns">
    <button class="btn ok" id="calcBtn">Calculate</button>
    <button class="btn warn" id="saveBtn">Save Journey</button>
    <button class="btn info" id="exportBtn">Export CSV</button>
    <button class="btn outline" id="resetBtn">Reset Fields</button>
    <button class="btn outline-danger" id="delPrevBtn">Delete Previous</button>
    <button class="btn danger" id="clearBtn">Clear Log</button>
  </div>
  <div class="tiny">Add to Home Screen for offline. Inputs auto-save.</div>
</div>

<div class="card">
  <div class="muted">Saved Journeys</div>
  <div style="max-height:45vh; overflow:auto; border:1px solid #eee; border-radius:12px; margin-top:6px">
    <table id="logTbl">
      <thead>
        <tr>
          <th>#</th><th>When</th><th>Min</th><th>Mi</th>
          <th>Rate 1 (core/range)</th><th>Rate 2 (core/range)</th><th>Rate 3 (core/range)</th><th>Meter</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ========= GLOBAL CONFIG ========= */
const APP_VERSION = 'v1.7';
const cfg = {
  baseFare: 4.20,
  inc: 0.20,
  // generic range bands (we will override with tolerance bands later)
  rangeBands: [
    { max: 1.5, lower:{fixed:0.30,pct:0.02}, upper:{fixed:0.60,pct:0.05} },
    { max: 2.5, lower:{fixed:0.60,pct:0.04}, upper:{fixed:1.00,pct:0.06} },
    { max: 4.5, lower:{fixed:1.00,pct:0.04}, upper:{fixed:1.60,pct:0.06} },
    { max: 6.5, lower:{fixed:1.60,pct:0.04}, upper:{fixed:2.00,pct:0.05} },
    { max: 1e9, lower:{fixed:2.00,pct:0.02}, upper:{fixed:2.50,pct:0.04} },
  ],
  /* ===== RATE 1 (all your latest tweaks) ===== */
  rate1:{
    // minute tiers: 1–12 normal, 13–25 slightly heavier, 26+ same
    perMinute:[{upTo:12,v:0.30},{upTo:25,v:0.36},{v:0.40}],
    perMileRules:[
      // 1.1–1.5 mi but time-heavy (your “slow 1.2” jobs)
      {when:{mMin:1.0,mMax:1.6,tMin:13,tMax:22}, v:3.30},
      // your 4.0–4.8 mi band that needed to land 35–39
      {when:{mMin:4.0,mMax:4.8,tMin:31,tMax:50}, v:4.30},
      {when:{mMin:4.0,mMax:4.8,tMin:16,tMax:30}, v:3.85},
      // generic helpers
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:3.65},
      // long stuff (still rate 1)
      {when:{mMin:25}, v:3.80},
      {when:{mMin:15}, v:3.95},
      {when:{mMin:7},  v:4.05},
      {when:{mMax:6.0}, v:3.60},
      {v:4.29}
    ],
    offsets:[
      // your 3–5 mi / 18–40 min uplift
      {when:{mMin:3.0,mMax:5.0,tMin:18,tMax:45}, d:1.20},
      // extra uplift for very slow short jobs 1.1–1.5 mi, ≥15 min
      {when:{mMin:1.0,mMax:1.6,tMin:15,tMax:30}, d:1.00}
    ],
    longTrim:{ enabled:true, when:{mMin:35,tMin:90}, pct:0.03, minAbs:2.00 }
  },

  /* ===== RATE 2 (your 1.4–1.5 mi correction + 4.0–4.6 mi correction) ===== */
  rate2:{
    perMinute:[{upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60}],
    perMileRules:[
      // NEW: 1.35–1.55 mi, 8–12 min should be ~£14–£16, we lift per-mile
      {when:{mMin:1.35,mMax:1.55,tMin:8,tMax:12}, v:4.10},
      // NEW: 1.35–1.55 mi, 12–16 min — slightly more
      {when:{mMin:1.35,mMax:1.55,tMin:12,tMax:18}, v:3.95},

      // previous targeted 3.9–4.6 fixes (these stay)
      {when:{mMin:4.1,mMax:4.6,tMin:16,tMax:19}, v:4.75},
      {when:{mMin:3.90,mMax:4.05,tMin:20,tMax:22}, v:4.55},
      {when:{mMin:3.80,mMax:4.10,tMin:23,tMax:26}, v:4.70},
      {when:{mMin:4.20,mMax:4.50,tMin:20,tMax:26}, v:5.35},
      {when:{mMin:4.20,mMax:4.50,tMin:27,tMax:40}, v:5.15},

      // original rules
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, v:3.85},
      {when:{mMin:18,mMax:25,tMin:55,tMax:70},  v:4.08},
      {when:{mMin:25}, v:4.12},
      {when:{mMin:7.5}, v:4.15},
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:4.00},
      {when:{mMin:1.8,mMax:2.2,tMin:10,tMax:20}, v:3.65},
      {v:4.29}
    ],
    offsets:[
      {when:{mMax:1.0}, d:0.00},
      {when:{mMin:1.5,mMax:2.8,tMin:12,tMax:20}, d:1.60},
      {when:{mMax:1.2,tMin:6,tMax:13}, d:0.40},
      {when:{mMin:7.5,mMax:10,tMin:40,tMax:55}, d:-1.20},
      {when:{mMin:18,mMax:21,tMin:45,tMax:60}, d:-1.20}
    ],
    longTrim:{ enabled:true, when:{mMin:25,tMin:65}, pct:0.05, minAbs:3.50 }
  },

  /* ===== RATE 3 (using your latest PDF) ===== */
rate3: {
  perMinute: [
    { upTo: 12, v: 0.58 },
    { upTo: 30, v: 0.62 },
    { v: 0.44 }
  ],
  perMileRules: [
    // Specific adjustments
    { when: { mMin: 3.35, mMax: 3.55, tMin: 19, tMax: 21 }, v: 3.25 },
    { when: { mMin: 3.35, mMax: 3.55, tMin: 24, tMax: 27 }, v: 3.70 },
    { when: { mMin: 4.4, mMax: 4.65, tMin: 19, tMax: 22 }, v: 3.95 },
    // Adjustments for longer journeys
    { when: { mMin: 9.0, mMax: 9.2, tMin: 35, tMax: 45 }, v: 5.8 },
    { when: { mMin: 8.5, mMax: 8.7, tMin: 25, tMax: 30 }, v: 5.4 },
    { when: { mMin: 7.8, mMax: 8.0, tMin: 32, tMax: 35 }, v: 5.2 },
    { when: { mMin: 6.3, mMax: 6.5, tMin: 24, tMax: 27 }, v: 4.9 },
    { when: { mMin: 5.8, mMax: 6.0, tMin: 25, tMax: 28 }, v: 4.8 },
    // Adjustments for shorter journey you mentioned
    { when: { mMin: 0.6, mMax: 0.7, tMin: 3, tMax: 4 }, v: 13.9 },
    // Keep existing shaping
    { when: { mMin: 4.0, mMax: 5.0, tMin: 12, tMax: 30 }, v: 3.55 },
    { when: { mMin: 5.0, mMax: 7.0, tMin: 12, tMax: 30 }, v: 3.50 },
    { when: { mMin: 3.0, mMax: 4.0, tMin: 12, tMax: 30 }, v: 3.40 },
    // fallback
    { v: 4.00 }
  ],
  offsets: [
    { when: { mMax: 0.5, tMax: 5 }, d: -0.60 },
    { when: { mMax: 0.8, tMax: 5 }, d: -0.40 },
    { when: { mMin: 1.8, mMax: 2.2, tMin: 9, tMax: 12 }, d: -1.20 },
    { when: { mMin: 5.5, mMax: 6.3, tMin: 28, tMax: 40 }, d: -1.40 },
    { when: { mMin: 18, mMax: 20, tMin: 45, tMax: 60 }, d: 1.20 },
    { when: { mMin: 4.0, mMax: 5.6, tMin: 15, tMax: 35 }, d: -0.80 },
    { when: { mMin: 6.5, mMax: 8.0, tMin: 22, tMax: 40 }, d: -1.00 }
  ]
}
};

/* ========= helpers ========= */
const r2 = (x)=>Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const floorTo  = (x,inc)=>Math.floor(x/inc)*inc;
const ceilTo   = (x,inc)=>Math.ceil (x/inc)*inc;
const $ = (id)=>document.getElementById(id);

/* ========= Persist inputs ========= */
const FORM_KEY='cabwizz_form_v1';
const FORM_IDS=['tStart','tEnd','miStart','miEnd','mins','miles','meter'];
function saveForm(){ const o={}; FORM_IDS.forEach(id=>o[id]=$(id).value??''); localStorage.setItem(FORM_KEY, JSON.stringify(o)); }
function loadForm(){ try{ const raw=localStorage.getItem(FORM_KEY); if(!raw) return; const o=JSON.parse(raw); FORM_IDS.forEach(id=>{ if(o[id]!==undefined) $(id).value=o[id]; }); }catch(e){} }
function clearForm(){ FORM_IDS.forEach(id=>$(id).value=''); saveForm(); }

/* ========= rule helpers ========= */
function matches(w, miles, mins){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  if(w.tMin!==undefined && mins  < w.tMin) return false;
  if(w.tMax!==undefined && mins  > w.tMax) return false;
  return true;
}
function pickPerMile(rules, miles, mins){
  const r = rules.find(x=>matches(x.when,miles,mins));
  return (r||rules[rules.length-1]).v;
}
function minutePart(tiers, mins){
  let rem=mins, used=0, sum=0;
  for(const t of tiers){
    if(t.upTo==null){ sum+=rem*t.v; break; }
    const span=Math.max(0, Math.min(rem, t.upTo-used));
    sum += span*t.v; rem-=span; used+=span;
    if(rem<=0) break;
  }
  return sum;
}
function sumOffsets(arr, miles, mins){
  return arr.reduce((s,o)=>s+(matches(o.when,miles,mins)?o.d:0),0);
}
function longTrim(core, trim, miles, mins){
  if(!trim||!trim.enabled) return core;
  if(!matches(trim.when,miles,mins)) return core;
  const rounded = roundTo(core, cfg.inc);
  const dec = Math.max(trim.minAbs, roundTo(rounded*trim.pct, cfg.inc));
  return roundTo(rounded - dec, cfg.inc);
}

/* ========= range by your tolerance ========= */
function buildRangeFromTolerance(core){
  let lower = core, upper = core;
  if (core <= 20){
    lower = core - 1.00;
    upper = core + 1.00;
  } else if (core <= 40){
    lower = core - 1.20;
    upper = core + 1.20;
  } else if (core <= 60){
    lower = core - 1.40;
    upper = core + 1.40;
  } else {
    lower = core - 1.60;
    upper = core + 1.60;
  }
  lower = floorTo(lower, cfg.inc);
  upper = ceilTo (upper, cfg.inc);
  return {lower, upper};
}

/* ========= Start/End → mins/miles ========= */
function parseTimeToMinutes(t){
  if(!t || !/^\d{2}:\d{2}$/.test(t)) return null;
  const [H,M] = t.split(':').map(Number);
  return H*60 + M;
}
function computeFromStartEnd(){
  const tS = parseTimeToMinutes($('tStart').value);
  const tE = parseTimeToMinutes($('tEnd').value);
  if(tS!=null && tE!=null){
    let diff = tE - tS;
    if(diff < 0) diff += 24*60;
    $('mins').value = String(Math.max(0, Math.round(diff)));
  }
  const ms = Number($('miStart').value);
  const me = Number($('miEnd').value);
  if(!Number.isNaN(ms) && !Number.isNaN(me) && $('miStart').value!=='' && $('miEnd').value!==''){
    const m = Math.max(0, r2(me - ms));
    $('miles').value = String(m);
  }
  saveForm();
}

/* ========= Fare core ========= */
function estimate(rateKey, mins, miles){
  const r = cfg[rateKey];
  const mPart = minutePart(r.perMinute, mins);
  const perMile = pickPerMile(r.perMileRules, miles, mins);
  let core = cfg.baseFare + mPart + perMile*miles + sumOffsets(r.offsets||[], miles, mins);

  // RATE 3: extra minute-lift after 30 min for 3–7 mi (kept from previous version)
  if (rateKey==='rate3' && miles>=3 && miles<=7 && mins>30){
    const k = 0.20 + 0.015*miles; // ≈£0.26–0.30 per extra min
    const extra = roundTo(k * (mins - 30), cfg.inc);
    core += extra;
  }

  if(r.longTrim) core = longTrim(core, r.longTrim, miles, mins);
  core = roundTo(core, cfg.inc);

  // final range = your 1.00 / 1.20 / 1.40 / 1.60 rule
  const rng = buildRangeFromTolerance(core);

  return { core, lower:rng.lower, upper:rng.upper };
}

/* ========= Rate rules + cross-over (kept same) ========= */
function rateNowLabelFor(startMinutes, weekday){ // weekday: 0=Sun..6=Sat
  const m = startMinutes; if(m==null) return 'Rate 1';
  const inR=(a,b)=> (m>=a && m<b); const R1='Rate 1',R2='Rate 2',R3='Rate 3';
  if(weekday>=1 && weekday<=5){ if(inR(300,1200)) return R1; if(inR(1200,1320)) return R2; return R3; }
  if(weekday===6){ if(inR(300,1320)) return R2; return R3; }
  if(weekday===0){ if(inR(300,1320)) return R2; return R3; }
  return R1;
}
function endRateLabelFor(startMin,endMin,weekday){
  let endWeekday = weekday;
  if(endMin<startMin) endWeekday = (weekday+1)%7;
  return rateNowLabelFor(endMin, endWeekday);
}

/* ========= UI helpers ========= */
function fmt(x){ return '£'+r2(x).toFixed(2); }
function fmtRange(core,lo,hi){ return `${fmt(core)}  (${fmt(lo)}–${fmt(hi)})`; }
function weekdayStamp(d=new Date()){
  const wk=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
  const pad=n=>String(n).padStart(2,'0');
  return `${wk} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ========= Calculate & render ========= */
function refresh(){
  computeFromStartEnd();
  const mins = Number($('mins').value);
  const miles= Number($('miles').value);
  if(Number.isNaN(mins)||Number.isNaN(miles)) return;

  const r1 = estimate('rate1', mins, miles);
  const r2 = estimate('rate2', mins, miles);
  const r3 = estimate('rate3', mins, miles);

  $('r1').textContent = fmtRange(r1.core, r1.lower, r1.upper);
  $('r2').textContent = fmtRange(r2.core, r2.lower, r2.upper);
  $('r3').textContent = fmtRange(r3.core, r3.lower, r3.upper);

  return {mins, miles, r1, r2, r3};
}

/* ========= On-screen log ========= */
const KEY='cabwizz_log_v1';
function loadLog(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return [] } }
function saveLog(rows){ localStorage.setItem(KEY, JSON.stringify(rows)); renderLog(); }
function renderLog(){
  const body = $('logBody'); body.innerHTML='';
  const rows = loadLog();
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td><td class="mono">${r.when}</td>
      <td>${r.mins}</td><td>${r.miles}</td>
      <td class="mono">${r.r1}</td><td class="mono">${r.r2}</td><td class="mono">${r.r3}</td>
      <td>${r.meter? '£'+Number(r.meter).toFixed(2):''}</td>`;
    body.appendChild(tr);
  });
}

/* ========= CSV ========= */
function exportCSV(){
  const rows = loadLog();
  const head = ['When','Minutes','Miles','Core/Range','Meter','Rate','Note','Start','End','AppVersion'];
  const out = [head];

  rows.forEach(r=>{
    out.push([ r.when, r.mins, r.miles, r.coreRangeForRate||'', r.meter||'', r.rateNow||'', r.note||'', r.start||'', r.end||'', APP_VERSION ]);
    if(r.crossed && r.endRate && r.endRate!==r.rateNow){
      out.push([ r.when, r.mins, r.miles, '', r.meter||'', r.endRate, `Crossover ${r.rateNow}→${r.endRate}`, r.start||'', r.end||'', APP_VERSION ]);
    }
  });

  const csv = out.map(arr=>arr.map(v=>{
    const s=String(v).replaceAll('"','""'); return `"${s}"`;
  }).join(',')).join('\r\n');

  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='cabwizz_journeys.csv'; a.click(); URL.revokeObjectURL(a.href);
}

/* ========= Optional webhook ========= */
const WEBHOOK_URL = '';
async function sendWebhook(payload){
  if(!WEBHOOK_URL) return;
  try{ await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }
  catch(e){ console.warn('Webhook failed',e); }
}

/* ========= Events ========= */
window.addEventListener('load', ()=>{ loadForm(); computeFromStartEnd(); renderLog(); });
document.getElementById('calcBtn').addEventListener('click', refresh);
['tStart','tEnd','miStart','miEnd','mins','miles','meter'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    if(id==='tStart'||id==='tEnd'||id==='miStart'||id==='miEnd') computeFromStartEnd(); else saveForm();
  });
});
document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset all input fields?')) clearForm(); });
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const res = refresh(); if(!res) return;
  const now = new Date();
  const whenStr = weekdayStamp(now);
  const tStartStr = $('tStart').value || '';
  const tEndStr   = $('tEnd').value   || '';
  const startMin = parseTimeToMinutes(tStartStr);
  const endMin   = parseTimeToMinutes(tEndStr);
  const weekday  = now.getDay();

  const rateNow = rateNowLabelFor(startMin, weekday);
  const endRate = (endMin!=null && startMin!=null) ? endRateLabelFor(startMin, endMin, weekday) : rateNow;
  const crossed = (endRate !== rateNow);

  const chosen = rateNow==='Rate 1' ? res.r1 : rateNow==='Rate 2' ? res.r2 : res.r3;
  const coreRangeForRate = `${fmt(chosen.core)} (${fmt(chosen.lower)}–${fmt(chosen.upper)})`;

  const meter = $('meter').value;

  const row = {
    when: whenStr,
    mins: res.mins, miles: res.miles,
    r1: fmtRange(res.r1.core,res.r1.lower,res.r1.upper),
    r2: fmtRange(res.r2.core,res.r2.lower,res.r2.upper),
    r3: fmtRange(res.r3.core,res.r3.lower,res.r3.upper),
    meter: meter? Number(meter).toFixed(2):'',
    rateNow, coreRangeForRate, crossed, start: tStartStr, end: tEndStr, endRate,
    note:'', version: APP_VERSION
  };
  const rows = loadLog(); rows.push(row); saveLog(rows);
  await sendWebhook(row);
  $('meter').value=''; saveForm();
});
document.getElementById('delPrevBtn').addEventListener('click', ()=>{
  const rows = loadLog();
  if(!rows.length) return;
  if(confirm('Delete the most recent saved journey?')){ rows.pop(); saveLog(rows); }
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  const rows = loadLog();
  if(!rows.length) return;
  if(confirm('Clear ALL saved journeys?')){ saveLog([]); }
});
document.getElementById('exportBtn').addEventListener('click', exportCSV);

/* ========= PWA ========= */
if (location.protocol.startsWith('http') && 'serviceWorker' in navigator) {
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').catch(console.warn); });
}
</script>
</body>
</html>
