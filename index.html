<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a7">
<title>CabWizz Fare Estimator</title>
<style>
  :root{--ok:#0a7;--warn:#f8a100;--info:#1869ff;--danger:#d33;--stroke:#d1d1d6}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:12px;line-height:1.25;background:#f7f7f8;color:#111}
  h1{font-size:18px;margin:0 0 8px;display:flex;gap:6px;align-items:center}
  .ver-tag{font-size:13px;color:#666;font-weight:500}
  .card{border:1px solid #e5e5ea;border-radius:16px;padding:14px;margin:10px 0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  label{display:block;font-size:14px;margin:10px 0 6px;color:#333}
  input,button{font-size:16px;padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);width:100%;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media (max-width:420px){.row,.row3{grid-template-columns:1fr}}
  .timeRow input[type="time"]{-webkit-appearance:none;appearance:none;text-align:center;min-height:48px}
  .out{font-weight:700}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{color:#666}
  .btns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .btn{border:none;color:#fff;font-weight:600;text-align:center;border-radius:16px;padding:14px;width:100%}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .info{background:var(--info)} .danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left}
  th{background:#fafafa}
</style>
</head>
<body>

<h1>
  CabWizz Fare Estimator
  <span id="version" class="ver-tag">(checking…)</span>
</h1>

<div class="card">
  <div class="row timeRow">
    <div>
      <label for="tStart">Start time</label>
      <input id="tStart" type="time" step="60" />
    </div>
    <div>
      <label for="tEnd">End time</label>
      <input id="tEnd" type="time" step="60" />
    </div>
  </div>

  <div class="row">
    <div>
      <label for="miStart">Start mileage</label>
      <input id="miStart" type="number" step="0.1" min="0" />
    </div>
    <div>
      <label for="miEnd">End mileage</label>
      <input id="miEnd" type="number" step="0.1" min="0" />
    </div>
  </div>

  <div class="row" style="margin-top:6px">
    <div>
      <label for="mins">Minutes</label>
      <input id="mins" type="number" min="0" />
    </div>
    <div>
      <label for="miles">Miles</label>
      <input id="miles" type="number" step="0.1" min="0" />
    </div>
  </div>

  <div style="margin-top:10px">
    <label for="meter">Actual meter fare (optional)</label>
    <input id="meter" type="number" step="0.01" min="0" />
  </div>

  <div class="row3" style="margin-top:12px">
    <div><div class="muted">Rate 1</div><div class="out mono" id="r1">–</div></div>
    <div><div class="muted">Rate 2</div><div class="out mono" id="r2">–</div></div>
    <div><div class="muted">Rate 3</div><div class="out mono" id="r3">–</div></div>
  </div>

  <div class="btns">
    <button class="btn ok" id="calcBtn">Calculate</button>
    <button class="btn warn" id="saveBtn">Save Journey</button>
    <button class="btn info" id="exportBtn">Export CSV</button>
    <button class="btn danger" id="clearBtn">Clear Log</button>
  </div>
</div>

<div class="card">
  <div class="muted">Saved journeys</div>
  <div style="max-height:45vh;overflow:auto;margin-top:6px;border:1px solid #eee;border-radius:10px">
    <table>
      <thead>
        <tr>
          <th>#</th><th>When</th><th>Min</th><th>Mi</th>
          <th>Rate 1</th><th>Rate 2</th><th>Rate 3</th><th>Meter</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</div>

<script>
const cfg = {
  baseFare: 4.20,
  inc: 0.20,
  rate1: {
    perMinute: [
      {upTo:12, v:0.30},
      {upTo:25, v:0.36},
      {v:0.40}
    ],
    perMileRules: [
      // your lifted 4.0–4.8mi band
      {when:{mMin:4.0,mMax:4.8,tMin:31,tMax:45}, v:4.30},
      {when:{mMin:4.0,mMax:4.8,tMin:16,tMax:30}, v:3.85},
      // normal helpers
      {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:3.65},
      {when:{mMin:25}, v:3.80},
      {when:{mMin:15}, v:3.95},
      {when:{mMin:7}, v:4.05},
      {when:{mMax:6.0}, v:3.60},
      {v:4.29}
    ],
    offsets: [
      // the “longer than normal for 1.1–1.5mi” uplift
      {when:{mMin:1.1,mMax:1.5,tMin:15,tMax:30}, d:1.60},
      // 3–5mi busy window uplift
      {when:{mMin:3.0,mMax:5.0,tMin:18,tMax:40}, d:1.20}
    ]
  },
  rate2: {
    perMinute: [{upTo:6,v:0.31},{upTo:12,v:0.33},{upTo:25,v:0.40},{v:0.60}],
    perMileRules: [{v:4.29}],
    offsets: []
  },
  rate3: {
    perMinute: [{upTo:12,v:0.58},{upTo:30,v:0.62},{v:0.44}],
    perMileRules: [{v:4.00}],
    offsets: []
  }
};

const $ = (id)=>document.getElementById(id);
const r2 = (x)=>Math.round(x*100)/100;
function roundTo(x,inc){return Math.round(x/inc)*inc;}

function matches(w,miles,mins){
  if(!w) return true;
  if(w.mMin!==undefined && miles < w.mMin) return false;
  if(w.mMax!==undefined && miles > w.mMax) return false;
  if(w.tMin!==undefined && mins  < w.tMin) return false;
  if(w.tMax!==undefined && mins  > w.tMax) return false;
  return true;
}
function pickPerMile(rules,miles,mins){
  const r = rules.find(x=>matches(x.when,miles,mins));
  return (r || rules[rules.length-1]).v;
}
function minutePart(tiers,mins){
  let rem=mins, used=0, sum=0;
  for (const t of tiers){
    if(t.upTo==null){ sum += rem*t.v; break; }
    const span = Math.max(0, Math.min(rem, t.upTo - used));
    sum += span * t.v;
    rem -= span;
    used += span;
    if(rem<=0) break;
  }
  return sum;
}
function sumOffsets(arr,miles,mins){
  return (arr||[]).reduce((s,o)=>s + (matches(o.when,miles,mins)?o.d:0),0);
}
function buildRange(core,miles,mins){
  // simple version: small trips = tight, big trips = wider
  let lower = 1.20, upper = 2.00;
  if (miles <= 1.0){ lower = 0.80; upper = 1.60; }
  else if (miles <= 2.5){ lower = 1.00; upper = 1.80; }
  else if (miles <= 4.5){ lower = 1.30; upper = 2.20; }
  else if (miles <= 6.5){ lower = 1.50; upper = 2.50; }
  else { lower = 2.00; upper = 3.00; }

  const lo = roundTo(core - lower, 0.20);
  const hi = roundTo(core + upper, 0.20);
  return {lower:lo, upper:hi};
}
function estimate(rateKey, mins, miles){
  const r = cfg[rateKey];
  const mPart = minutePart(r.perMinute, mins);
  const perMile = pickPerMile(r.perMileRules, miles, mins);
  let core = cfg.baseFare + mPart + perMile*miles + sumOffsets(r.offsets, miles, mins);
  core = roundTo(core, cfg.inc);
  const rng = buildRange(core, miles, mins);
  return {core, lower:rng.lower, upper:rng.upper};
}

function refresh(){
  const mins = Number($('mins').value || 0);
  const miles = Number($('miles').value || 0);
  const r1 = estimate('rate1', mins, miles);
  const r2 = estimate('rate2', mins, miles);
  const r3 = estimate('rate3', mins, miles);
  $('r1').textContent = `£${r1.core.toFixed(2)} (£${r1.lower.toFixed(2)}–£${r1.upper.toFixed(2)})`;
  $('r2').textContent = `£${r2.core.toFixed(2)} (£${r2.lower.toFixed(2)}–£${r2.upper.toFixed(2)})`;
  $('r3').textContent = `£${r3.core.toFixed(2)} (£${r3.lower.toFixed(2)}–£${r3.upper.toFixed(2)})`;
  return {mins,miles,r1,r2,r3};
}

const LOG_KEY='cabwizz_log_v1';
function loadLog(){ try{return JSON.parse(localStorage.getItem(LOG_KEY)||'[]')}catch(e){return[]} }
function saveLog(rows){ localStorage.setItem(LOG_KEY, JSON.stringify(rows)); renderLog(); }
function renderLog(){
  const body = $('logBody'); body.innerHTML='';
  const rows = loadLog();
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.when}</td>
      <td>${r.mins}</td>
      <td>${r.miles}</td>
      <td>${r.r1}</td>
      <td>${r.r2}</td>
      <td>${r.r3}</td>
      <td>${r.meter? '£'+r.meter:''}</td>
    `;
    body.appendChild(tr);
  });
}

function nowStr(){
  const d=new Date();
  return d.toLocaleString();
}

window.addEventListener('load',()=>{
  renderLog();
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(reg=>{
      // ask SW for version
      if (reg.active){
        reg.active.postMessage({type:'GET_VERSION'});
      }
    }).catch(console.warn);
  }
});

$('calcBtn').addEventListener('click', refresh);
$('saveBtn').addEventListener('click', ()=>{
  const res = refresh();
  const row = {
    when: nowStr(),
    mins: res.mins,
    miles: res.miles,
    r1: $('r1').textContent,
    r2: $('r2').textContent,
    r3: $('r3').textContent,
    meter: $('meter').value
  };
  const rows = loadLog(); rows.push(row); saveLog(rows);
});
$('exportBtn').addEventListener('click', ()=>{
  const rows = loadLog();
  let csv = 'When,Minutes,Miles,Rate1,Rate2,Rate3,Meter\r\n';
  rows.forEach(r=>{
    csv += `"${r.when}",${r.mins},${r.miles},"${r.r1}","${r.r2}","${r.r3}",${r.meter||''}\r\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='cabwizz_journeys.csv';
  a.click();
});
$('clearBtn').addEventListener('click', ()=>{
  if (confirm('Clear all saved journeys?')){
    saveLog([]);
  }
});

// listen for version from SW
if ('serviceWorker' in navigator){
  navigator.serviceWorker.addEventListener('message', (evt)=>{
    if (evt.data && evt.data.type === 'VERSION'){
      const el = $('version');
      el.textContent = '— ' + evt.data.version;
      el.title = evt.data.cache;
    }
  });
}
</script>
</body>
</html>
