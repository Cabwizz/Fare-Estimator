<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rate-1 Batch Tester & Tuner</title>
<style>
  :root{--ok:#0a7;--warn:#f8a100;--info:#1869ff;--danger:#d33;--stroke:#ddd}
  *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f7f8;color:#111;margin:12px}
  h1{font-size:18px;margin:0 0 10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid #e5e5ea;border-radius:14px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  textarea,input,select,button{width:100%;font-size:14px;padding:10px;border:1px solid var(--stroke);border-radius:10px;background:#fff}
  label{font-size:13px;color:#333;margin-top:8px;display:block}
  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .btn{border:none;color:#fff;background:#0a7;padding:12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#1869ff}
  .btn.warn{background:#f8a100}
  .btn.danger{background:#d33}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .muted{color:#666;font-size:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eafaf3;color:#05603a;font-size:11px;margin-left:6px}
  .bad{background:#fff3f3;color:#a10000}
  .okval{color:#05603a}
  .small{font-size:12px}
</style>
</head>
<body>
<h1>Rate-1 Batch Tester & Tuner <span class="pill" id="ver">v1.0</span></h1>

<div class="grid">
  <!-- LEFT: data + controls -->
  <div class="card">
    <h3 style="margin:0 0 8px">Paste your dataset</h3>
    <div class="muted" style="margin-bottom:6px">
      One row per journey, **comma or tab separated**: <span class="mono">minutes, miles, meter</span> (headers optional).<br>
      Example: <span class="mono">14, 1.9, 16.20</span>
    </div>
    <textarea id="data" rows="10" placeholder="minutes,miles,meter
14,1.9,16.20
17,1.9,18.60
18,1.9,17.60
23,2.9,23.20"></textarea>
    <div class="row2" style="margin-top:8px">
      <button class="btn" id="runBtn">Test Run</button>
      <button class="btn secondary" id="exportBtn">Export Results (CSV)</button>
    </div>
    <div class="row2" style="margin-top:8px">
      <button class="btn warn" id="saveCfgBtn">Copy JS Snippet (paste into estimator)</button>
      <button class="btn danger" id="clearBtn">Clear</button>
    </div>
  </div>

  <!-- RIGHT: tunables -->
  <div class="card">
    <h3 style="margin:0 0 8px">Tune Rate-1 parameters</h3>
    <div class="row2">
      <div>
        <label>Base fare (£)</label>
        <input id="p_base" type="number" step="0.01" value="4.20">
      </div>
      <div>
        <label>Rounding increment (£)</label>
        <input id="p_inc" type="number" step="0.10" value="0.20">
      </div>
    </div>

    <h4 style="margin:10px 0 6px">Per-minute tiers</h4>
    <div class="row3">
      <div>
        <label>0–12 min (£/min)</label>
        <input id="pm0" type="number" step="0.01" value="0.30">
      </div>
      <div>
        <label>12–25 min (£/min)</label>
        <input id="pm1" type="number" step="0.01" value="0.36">
      </div>
      <div>
        <label>25+ min (£/min)</label>
        <input id="pm2" type="number" step="0.01" value="0.40">
      </div>
    </div>

    <h4 style="margin:10px 0 6px">Per-mile rules (choose one by range)</h4>
    <div class="muted small">These mimic your live estimator’s Rate-1 per-mile map. Adjust values only.</div>
    <div class="row">
      <div>
        <label>m &lt;= 6.0</label>
        <input id="pp_mle6" type="number" step="0.01" value="3.60">
      </div>
      <div>
        <label>7–14 min</label>
        <input id="pp_7" type="number" step="0.01" value="4.05">
      </div>
      <div>
        <label>15–24 min</label>
        <input id="pp_15" type="number" step="0.01" value="3.95">
      </div>
      <div>
        <label>25+ min</label>
        <input id="pp_25" type="number" step="0.01" value="3.80">
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <div>
        <label>3.5–4.5 mi &amp; 16–30 min</label>
        <input id="pp_35_45" type="number" step="0.01" value="3.65">
      </div>
      <div>
        <label>4.0–4.8 mi &amp; 16–30 min</label>
        <input id="pp_40_48_mid" type="number" step="0.01" value="3.85">
      </div>
      <div>
        <label>4.0–4.8 mi &amp; 31–45 min</label>
        <input id="pp_40_48_high" type="number" step="0.01" value="4.30">
      </div>
      <div>
        <label>Fallback per-mile</label>
        <input id="pp_fallback" type="number" step="0.01" value="4.29">
      </div>
    </div>

    <h4 style="margin:10px 0 6px">Offsets</h4>
    <div class="muted small">Add/subtract for specific pockets (kept simple: one common offset).</div>
    <div class="row2">
      <div>
        <label>Offset (m: 3–5, t: 18–40)</label>
        <input id="off_common" type="number" step="0.20" value="1.20">
      </div>
      <div>
        <label>Long-trip trim (%) after 90m &amp; 35mi</label>
        <input id="trim_pct" type="number" step="0.01" value="0.03">
      </div>
    </div>

    <h4 style="margin:10px 6px 6px">Range rules (global clamp)</h4>
    <div class="row">
      <div><label>£6–£20 (±)</label><input id="rg_20" type="number" step="0.10" value="1.00"></div>
      <div><label>£20–£40 (±)</label><input id="rg_40" type="number" step="0.10" value="1.20"></div>
      <div><label>£40–£60 (±)</label><input id="rg_60" type="number" step="0.10" value="1.40"></div>
      <div><label>£60+ (±)</label><input id="rg_80" type="number" step="0.10" value="1.60"></div>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div class="card" style="margin-top:12px">
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <h3 style="margin:0">Results</h3>
    <div class="muted">MAE: <span id="mae" class="mono okval">–</span> | MAPE: <span id="mape" class="mono okval">–</span> | RMSE: <span id="rmse" class="mono okval">–</span></div>
  </div>
  <div style="max-height:60vh;overflow:auto;border:1px solid #eee;border-radius:12px;margin-top:6px">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th><th>Min</th><th>Mi</th>
          <th>Meter</th><th>Core</th><th>Low</th><th>High</th><th>Error</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = (id)=>document.getElementById(id);
const r2 = (x)=>Math.round(x*100)/100;
const roundTo = (x,inc)=>Math.round(x/inc)*inc;
const floorTo  = (x,inc)=>Math.floor(x/inc)*inc;
const ceilTo   = (x,inc)=>Math.ceil (x/inc)*inc;

function parseCSV(text){
  return text.trim().split(/\r?\n/).map(l=>{
    const parts = l.split(/,|\t/).map(s=>s.trim());
    if(!parts.length) return null;
    // skip header lines if first cell not numeric
    if(isNaN(parseFloat(parts[0]))) return null;
    const m = Number(parts[0]), mi = Number(parts[1]), fare = Number(parts[2]);
    if([m,mi,fare].some(v=>Number.isNaN(v))) return null;
    return {mins:m, miles:mi, meter:fare};
  }).filter(Boolean);
}

/* ---------- live Rate-1 model (same shape as app, tunable) ---------- */
function pickPerMile(params, miles, mins){
  const {
    pp_mle6, pp_7, pp_15, pp_25,
    pp_35_45, pp_40_48_mid, pp_40_48_high, pp_fallback
  } = params;

  if (miles <= 6.0)             return pp_mle6;
  if (mins >= 25)               return pp_25;
  if (mins >= 15)               return pp_15;
  if (mins >= 7)                return pp_7;
  if (miles>=4.0 && miles<=4.8 && mins>=31 && mins<=45) return pp_40_48_high;
  if (miles>=4.0 && miles<=4.8 && mins>=16 && mins<=30) return pp_40_48_mid;
  if (miles>=3.5 && miles<=4.5 && mins>=16 && mins<=30) return pp_35_45;
  return pp_fallback;
}

function minutePart(params, mins){
  const {pm0,pm1,pm2} = params;
  let rem=mins, used=0, sum=0;
  const tiers = [{upTo:12,v:pm0},{upTo:25,v:pm1},{v:pm2}];
  for(const t of tiers){
    if(t.upTo==null){ sum+=rem*t.v; break; }
    const span=Math.max(0, Math.min(rem, t.upTo-used));
    sum += span*t.v; rem-=span; used+=span;
    if(rem<=0) break;
  }
  return sum;
}

function offsets(params, miles, mins){
  let s=0;
  if (miles>=3.0 && miles<=5.0 && mins>=18 && mins<=40) s += params.off_common;
  return s;
}

function longTrim(core, params, miles, mins){
  // using your old condition (rare edge)
  if (miles>=35 && mins>=90){
    const dec=Math.max(params.trim_pct*core, 2.00);
    return core - dec;
  }
  return core;
}

function applyRangeClamp(core, params){
  const {rg_20, rg_40, rg_60, rg_80} = params;
  let band = rg_80;
  if (core<=20) band = rg_20;
  else if (core<=40) band = rg_40;
  else if (core<=60) band = rg_60;
  return {low: core - band, high: core + band};
}

function estimateRate1(mins, miles, P){
  const inc = P.inc;
  let core = P.base + minutePart(P, mins) + pickPerMile(P, miles, mins)*miles + offsets(P, miles, mins);
  core = longTrim(core, P, miles, mins);
  core = roundTo(core, inc);
  const clamp = applyRangeClamp(core, P);
  let low  = floorTo(roundTo(clamp.low,  inc), inc);
  let high = ceilTo (roundTo(clamp.high, inc), inc);
  if (miles<=0.8 && low<6.20) low=roundTo(6.20, inc);
  return {core, low, high};
}

/* ---------- run + render ---------- */
function getParams(){
  return {
    base: Number($('p_base').value||4.20),
    inc: Number($('p_inc').value||0.20),

    pm0: Number($('pm0').value||0.30),
    pm1: Number($('pm1').value||0.36),
    pm2: Number($('pm2').value||0.40),

    pp_mle6: Number($('pp_mle6').value||3.60),
    pp_7: Number($('pp_7').value||4.05),
    pp_15: Number($('pp_15').value||3.95),
    pp_25: Number($('pp_25').value||3.80),
    pp_35_45: Number($('pp_35_45').value||3.65),
    pp_40_48_mid: Number($('pp_40_48_mid').value||3.85),
    pp_40_48_high: Number($('pp_40_48_high').value||4.30),
    pp_fallback: Number($('pp_fallback').value||4.29),

    off_common: Number($('off_common').value||1.20),
    trim_pct: Number($('trim_pct').value||0.03),

    rg_20: Number($('rg_20').value||1.00),
    rg_40: Number($('rg_40').value||1.20),
    rg_60: Number($('rg_60').value||1.40),
    rg_80: Number($('rg_80').value||1.60),
  };
}

function run(){
  const rows = parseCSV($('data').value);
  const P = getParams();
  const tbody = $('tbody'); tbody.innerHTML='';
  let errAbs=0, errPct=0, errSq=0, n=0;

  rows.forEach((r,i)=>{
    const est = estimateRate1(r.mins, r.miles, P);
    const err = est.core - r.meter;
    const pct = r.meter>0 ? Math.abs(err)/r.meter : 0;
    errAbs += Math.abs(err); errPct += pct; errSq += err*err; n++;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.mins}</td>
      <td>${r.miles.toFixed(1)}</td>
      <td class="mono">£${r.meter.toFixed(2)}</td>
      <td class="mono">£${est.core.toFixed(2)}</td>
      <td class="mono">£${est.low.toFixed(2)}</td>
      <td class="mono">£${est.high.toFixed(2)}</td>
      <td class="mono ${Math.abs(err)>1.2?'bad':''}">${err>=0?'+':''}${err.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

  if(n>0){
    $('mae').textContent = '£'+(errAbs/n).toFixed(2);
    $('mape').textContent = ((errPct/n)*100).toFixed(1)+'%';
    $('rmse').textContent = '£'+Math.sqrt(errSq/n).toFixed(2);
  }else{
    $('mae').textContent = $('mape').textContent = $('rmse').textContent = '–';
  }

  // persist
  localStorage.setItem('cw_rate1_tester_params', JSON.stringify(P));
  localStorage.setItem('cw_rate1_tester_data', $('data').value);
}

function exportCSV(){
  const table = document.getElementById('tbl');
  let csv = [];
  const head = Array.from(table.tHead.rows[0].cells).map(th=>`"${th.textContent}"`).join(',');
  csv.push(head);
  Array.from(table.tBodies[0].rows).forEach(tr=>{
    const row = Array.from(tr.cells).map(td=>`"${td.textContent.replaceAll('"','""')}"`).join(',');
    csv.push(row);
  });
  const blob = new Blob([csv.join('\r\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='rate1_tester_results.csv'; a.click(); URL.revokeObjectURL(a.href);
}

function copySnippet(){
  const P = getParams();
  const js = `
/* === Rate 1 (from tester) === */
rate1:{
  perMinute:[{upTo:12,v:${P.pm0.toFixed(2)}},{upTo:25,v:${P.pm1.toFixed(2)}},{v:${P.pm2.toFixed(2)}}],
  perMileRules:[
    {when:{mMax:6.0}, v:${P.pp_mle6.toFixed(2)}},
    {when:{mMin:4.0,mMax:4.8,tMin:31,tMax:45}, v:${P.pp_40_48_high.toFixed(2)}},
    {when:{mMin:4.0,mMax:4.8,tMin:16,tMax:30}, v:${P.pp_40_48_mid.toFixed(2)}},
    {when:{mMin:3.5,mMax:4.5,tMin:16,tMax:30}, v:${P.pp_35_45.toFixed(2)}},
    {when:{mMin:25}, v:${P.pp_25.toFixed(2)}},
    {when:{mMin:15}, v:${P.pp_15.toFixed(2)}},
    {when:{mMin:7},  v:${P.pp_7.toFixed(2)}},
    {v:${P.pp_fallback.toFixed(2)}}
  ],
  offsets:[
    {when:{mMin:3.0,mMax:5.0,tMin:18,tMax:40}, d:${P.off_common.toFixed(2)}}
  ],
  longTrim:{ enabled:true, when:{mMin:35,tMin:90}, pct:${P.trim_pct.toFixed(2)}, minAbs:2.00 }
},
/* global */
baseFare:${P.base.toFixed(2)}, inc:${P.inc.toFixed(2)},
/* range clamps */
ranges:{ s20:${P.rg_20.toFixed(2)}, s40:${P.rg_40.toFixed(2)}, s60:${P.rg_60.toFixed(2)}, s80:${P.rg_80.toFixed(2)} }
`.trim();

  navigator.clipboard.writeText(js).then(()=>{
    alert('Copied Rate-1 snippet to clipboard.\nPaste into your estimator’s cfg (rate1 + base/inc + clamp values).');
  });
}

function loadPersist(){
  try{
    const p = JSON.parse(localStorage.getItem('cw_rate1_tester_params')||'{}');
    Object.entries(p).forEach(([k,v])=>{ const el=$(k.replace(/^/,'p_')); if($(k)) $(k).value=v; });
    $('data').value = localStorage.getItem('cw_rate1_tester_data') || $('data').value;
  }catch(e){}
}

/* ---------- events ---------- */
window.addEventListener('load', ()=>{
  loadPersist();
  $('runBtn').addEventListener('click', run);
  $('exportBtn').addEventListener('click', exportCSV);
  $('saveCfgBtn').addEventListener('click', copySnippet);
  $('clearBtn').addEventListener('click', ()=>{
    if(confirm('Clear data and results?')){ $('data').value=''; $('tbody').innerHTML=''; localStorage.removeItem('cw_rate1_tester_data'); }
  });
});
</script>
</body>
</html>
